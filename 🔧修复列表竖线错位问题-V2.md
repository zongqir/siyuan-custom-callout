# 🔧 修复列表竖线错位问题 - V2（点线一体方案）

## 🎯 核心洞察

用户提出的关键观察：**"思源的点（项目符号）和线（连接竖线）是整体的"**

这个洞察非常准确！思源笔记的列表系统是一个完整的整体：
- `.protyle-action` 显示项目符号（"点"）
- `::before` 伪元素显示竖线（"线"）
- 两者的位置是配套设计的，竖线正好在 `.protyle-action` 的中间

## ❌ 之前的错误方案

之前的修复尝试使用了 **CSS 原生的 `list-style-type`**，这导致了两个系统的混用：
```css
/* 错误：混用两个系统 */
display: list-item !important;
list-style-type: disc !important;  /* ← CSS 原生系统 */
```

同时又试图调整 `::before` 竖线的位置，但由于两个系统不兼容，导致：
- 竖线位置计算错误
- 项目符号和竖线无法对齐
- 布局混乱

## ✅ 正确方案：使用思源原生系统

完全移除 CSS 的 `list-style`，**只使用思源原生的 `.protyle-action` + `::before` 系统**，仅调整尺寸以适应紧凑布局。

### 核心参数调整

```css
/* 原生思源 → Callout 紧凑模式 */
.protyle-action 宽度:  34px  →  24px
竖线位置 (left):       17px  →  12px  (24px / 2)
列表项间距:             8px  →   4px
子元素 margin-left:    34px  →  24px
```

### 完整实现

```css
/* 1. 列表项基础样式 */
.protyle-wysiwyg .bq[custom-callout] div[data-type="NodeListItem"] {
    padding: 0 !important;
    display: flex !important;
    flex-direction: column !important;
    min-height: calc(1.625em + 4px) !important;  /* 4px 代替 8px */
    margin: 2px 0 !important;
}

/* 2. 竖线样式：位置在 .protyle-action 的中间 */
.protyle-wysiwyg .bq[custom-callout] div[data-type="NodeListItem"]::before {
    content: "" !important;
    position: absolute !important;
    border-left: 0.5px solid var(--b3-theme-background-light) !important;
    left: 12px !important;                      /* 24px / 2 = 12px */
    height: calc(100% - 1.625em - 4px) !important;
    top: calc(1.625em + 4px) !important;
}

/* 3. .protyle-action：显示项目符号的容器 */
.protyle-wysiwyg .bq[custom-callout] div[data-type="NodeListItem"] > .protyle-action {
    left: 0 !important;
    position: absolute !important;
    width: 24px !important;                     /* 从 34px 缩小到 24px */
    height: calc(1.625em + 4px) !important;
    /* ...其他样式保持原生... */
}

/* 4. 子元素左边距：为 .protyle-action 腾出空间 */
.protyle-wysiwyg .bq[custom-callout] div[data-type="NodeListItem"] > [data-node-id],
.protyle-wysiwyg .bq[custom-callout] div[data-type="NodeListItem"] > div[data-type="NodeParagraph"] {
    margin-left: 24px !important;               /* 与 .protyle-action 宽度一致 */
}
```

## 🎨 工作原理

### 思源原生系统的完整逻辑

```
┌─────────────────────────────────────┐
│ NodeListItem (列表项)                │
│                                     │
│  ┌─────┐                            │
│  │  •  │ ← .protyle-action (24px)   │
│  └──┬──┘                            │
│     │ ← ::before 竖线 (left: 12px)  │
│     │                               │
│     │    ┌─────────────────────┐   │
│     │    │ NodeParagraph       │   │
│     │    │ (margin-left: 24px) │   │
│     │    └─────────────────────┘   │
│     │                               │
│     │    ┌─────────────────────┐   │
│     ├────│ 嵌套 NodeListItem   │   │
│     │    │                     │   │
│     │    └─────────────────────┘   │
└─────────────────────────────────────┘
```

**关键要素**：
1. `.protyle-action` 宽度 24px，显示 `•` 或 `1.` 等标记
2. 竖线位置 `left: 12px`，正好在 `.protyle-action` 中间
3. 子元素 `margin-left: 24px`，为 `.protyle-action` 腾出空间
4. 竖线从第一行文本底部开始，向下延伸连接子项

### 为什么"点线一体"

思源的设计哲学：
- **项目符号由 JavaScript 动态生成**，注入到 `.protyle-action` 中
- **竖线通过 CSS** 绘制，位置精确对齐 `.protyle-action` 中心
- **两者共享同一套尺寸参数**，确保完美对齐

如果混用 CSS 的 `list-style`：
- CSS 原生的项目符号位置由浏览器控制，无法精确对齐
- `::before` 竖线的参数是基于 `.protyle-action` 计算的
- 两个系统的参数不匹配 → 错位

## 📊 对比表

| 方案 | 项目符号 | 竖线 | 对齐性 | 复杂度 |
|------|---------|------|--------|-------|
| **V1（错误）** | CSS list-style | CSS ::before | ❌ 错位 | 🔴 高（两套系统） |
| **V2（正确）** | .protyle-action | CSS ::before | ✅ 完美 | 🟢 低（一套系统） |

## 🔧 技术细节

### 缩小尺寸的计算

```javascript
// 原生思源的设计比例
原生宽度 = 34px
竖线位置 = 34px / 2 = 17px

// Callout 紧凑模式（缩小约 30%）
紧凑宽度 = 24px  
竖线位置 = 24px / 2 = 12px

// 间距也相应缩小
原生间距 = 8px (min-height, height, top, bottom)
紧凑间距 = 4px
```

### 为什么选择 24px

1. **视觉平衡**：24px 足够显示项目符号（`•`、`1.`等）
2. **紧凑性**：比 34px 减少 30%，更适合 Callout 的紧凑布局
3. **整数比例**：12px = 24px / 2，计算简单，像素完美

## ✨ 优势

### 1. 完美对齐
竖线始终在 `.protyle-action` 中心，无论内容如何变化

### 2. 系统一致性
使用思源原生系统，兼容所有列表类型：
- 无序列表（`•`）
- 有序列表（`1.`、`2.`）
- 任务列表（`☐`、`☑`）
- 嵌套列表

### 3. 易维护
只有一套系统，参数联动：
- 修改 `.protyle-action` 宽度 → 竖线自动对齐
- 修改间距 → 高度自动适配

### 4. 动态支持
`.protyle-action` 的内容由思源 JavaScript 动态生成，支持：
- 自动编号
- 折叠/展开
- 拖拽排序
- 所有原生交互

## 🧪 测试场景

```markdown
> [!note] 测试列表
> - 项目 1
> - 项目 2
>   - 嵌套 2.1
>     - 深层嵌套 2.1.1
>   - 嵌套 2.2
> - 项目 3

> [!tip] 有序列表
> 1. 第一项
> 2. 第二项
>    1. 嵌套 2.1
>    2. 嵌套 2.2
> 3. 第三项

> [!task] 任务列表
> - [ ] 未完成任务
> - [x] 已完成任务
>   - [ ] 子任务 1
>   - [ ] 子任务 2
```

验证要点：
- ✅ 所有类型的项目符号正常显示
- ✅ 竖线位置正确（在符号中心）
- ✅ 嵌套层级对齐准确
- ✅ 折叠/展开正常工作
- ✅ 悬停高亮效果一致

## 📝 总结

**关键原则**：尊重思源原生设计，不要重新发明轮子

- ❌ **错误思路**：用 CSS `list-style` 替换思源系统 → 两个系统冲突
- ✅ **正确思路**：使用思源原生系统，只调整尺寸 → 点线完美一体

**核心公式**：
```
竖线位置 = .protyle-action 宽度 / 2
子元素左边距 = .protyle-action 宽度
```

这样"点"和"线"永远是一个整体，无论如何调整尺寸都能完美对齐。

---

**版本**: V2  
**日期**: 2025-10-09  
**状态**: ✅ 完美解决


# 🔧 修复边注命令格式问题

## 问题描述
用户发现在面板筛选逻辑下，选择 `info|right` 后生成的命令是 `[!info]|right` 而不是正确的 `[!info|right]`。

## 根源分析
问题出现在两个地方：

### 1. 正则表达式匹配不完整
**修复前**：
```javascript
const match = currentText.match(/^\[!([^|\]]+)/);  // 只匹配到第一个 | 或 ]
```

**修复后**：
```javascript
const match = currentText.match(/^\[!([^|\]]+)(\|.*?)?\]?/);  // 完整匹配整个命令
```

### 2. processBlockquote 调用干扰
边注设置后立即调用 `processBlockquote` 可能会触发其他处理逻辑，导致命令被重新解析或修改。

**临时解决方案**：注释掉 `applyMarginNoteSetting` 最后的 `processBlockquote` 调用。

## 🧪 测试步骤

### 测试 1: 直接边注选择
1. 创建引述块：`> `
2. 选择任意 Callout 类型（如 info）
3. **立即点击底部工具栏的边注按钮**（左侧或右侧）
4. **查看标题中的命令**

**期望结果**：`[!info|left]` 或 `[!info|right]`  
**错误结果**：`[!info]|left` 或 `[!info]|right`

### 测试 2: 查看浏览器控制台
打开浏览器开发者工具（F12），在控制台中应该能看到调试信息：
```
边注设置 - 当前文本: [!info] 提取类型: info 新命令: [!info|right]
```

### 测试 3: DOM 属性验证
选择边注后，检查 blockquote 元素是否有正确的属性：
- `data-margin-position="right"`  
- `data-margin-width="30%"`
- `data-margin-spacing="1em"`

## 🔍 预期修复效果

### **修复前（错误）**：
```
操作流程：选择 info → 点击右侧边注
结果命令：[!info]|right  ❌
```

### **修复后（正确）**：
```
操作流程：选择 info → 点击右侧边注  
结果命令：[!info|right]  ✅
```

## 🚨 如果仍有问题

### 情况1：控制台显示正确，但命令仍错误
说明在其他地方有逻辑覆盖了设置，可能需要检查：
- 其他事件监听器
- SiYuan 内部的处理逻辑
- 时序问题

### 情况2：控制台没有调试信息
说明边注工具栏的点击事件没有触发，检查：
- 按钮是否正确生成
- 事件监听器是否正确绑定

### 情况3：命令正确但样式不生效
说明 CSS 或属性设置有问题，检查：
- DOM 属性是否正确设置
- CSS 样式是否正确加载

## 📋 测试清单

请依次测试并告诉我结果：

- [ ] **基础命令生成**：`[!info|right]` 格式是否正确？
- [ ] **控制台日志**：是否看到调试信息？  
- [ ] **DOM 属性**：`data-margin-position` 等属性是否正确？
- [ ] **视觉效果**：边注是否正确浮动到右侧？
- [ ] **多次切换**：普通 → 左侧 → 右侧 → 普通，是否都正确？

## 🎯 下一步

如果修复成功，我会：
1. 移除调试日志
2. 恢复 `processBlockquote` 调用（如果需要的话）
3. 进行完整的功能测试

请测试后告诉我具体的结果！🔧

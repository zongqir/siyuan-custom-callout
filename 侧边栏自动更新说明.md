# 侧边栏自动更新功能说明

## 🎯 本次改进内容

### 1. **修复自定义类型无法显示的问题**

**问题描述：**
- 之前侧边栏（Callout Outline）只能识别预设的 Callout 类型
- 用户自己添加的自定义 Callout 类型无法在侧边栏中显示

**解决方案：**
- 从静态导入 `DEFAULT_CALLOUT_TYPES` 改为动态加载配置
- 使用 `ConfigManager.getAllTypes()` 获取所有类型（包括预设和自定义）
- 在组件挂载时初始化类型映射
- 在刷新时重新加载类型映射

**修改文件：**
- `src/dock/callout-outline.svelte` - 动态加载类型映射
- `src/settings/panel-v2.svelte` - 保存配置后通知侧边栏更新

---

### 2. **实现智能自动更新机制**

**问题描述：**
- 用户添加、删除或修改 Callout 块后，侧边栏列表不会自动更新
- 需要手动点击刷新按钮才能看到最新内容

**解决方案：**
使用 `MutationObserver` API 监听文档变化，实现以下功能：

#### 📌 监听事件类型

1. **Callout 块的添加**
   - 检测新创建的带有 `custom-callout` 属性的引述块
   - 自动刷新侧边栏列表

2. **Callout 块的删除**
   - 检测被删除的 Callout 块
   - 从侧边栏列表中移除

3. **Callout 类型的变更**
   - 监听 `custom-callout` 属性的变化
   - 更新侧边栏中对应项的显示

4. **折叠状态的变化**
   - 监听 `data-collapsed` 属性的变化
   - 实时更新折叠图标显示

5. **文档切换**
   - 检测用户切换到其他文档
   - 自动重新设置监听器并加载新文档的 Callout

6. **配置变化**
   - 监听设置面板中的配置保存
   - 自动重新加载类型映射（包括新添加的自定义类型）
   - 保证侧边栏始终显示最新的类型配置

#### ⚡ 性能优化

- **防抖机制**：避免频繁更新导致性能问题
  - Callout 增删：300ms 延迟
  - 折叠状态变化：100ms 延迟（更快响应）
  
- **精确监听**：只监听关键属性
  - `custom-callout`：Callout 类型标识
  - `data-collapsed`：折叠状态
  
- **智能判断**：只在真正有 Callout 变化时才触发更新

#### 🔄 自动清理机制

- 组件销毁时自动断开 MutationObserver
- 文档切换时重新设置监听器
- 防止内存泄漏

---

## 💡 使用场景

### 场景 1：创建新的 Callout
```
1. 在文档中输入 [!info] 或其他 Callout 命令
2. 侧边栏自动检测到新的 Callout
3. 列表自动更新，无需手动刷新 ✅
```

### 场景 2：删除 Callout
```
1. 删除文档中的某个 Callout 块
2. 侧边栏自动检测到删除操作
3. 列表自动更新，移除对应项 ✅
```

### 场景 3：折叠/展开 Callout
```
1. 点击 Callout 的折叠按钮
2. 侧边栏立即更新折叠图标状态 ✅
```

### 场景 4：使用自定义类型
```
1. 在设置中添加自定义 Callout 类型
2. 在文档中使用自定义类型创建 Callout
3. 侧边栏能正确识别并显示自定义类型 ✅
```

### 场景 5：切换文档
```
1. 从文档 A 切换到文档 B
2. 侧边栏自动加载文档 B 的 Callout 列表
3. 监听器自动重新设置到新文档 ✅
```

### 场景 6：在设置面板中添加自定义类型
```
1. 打开设置面板
2. 点击"添加新类型"，创建一个自定义 Callout 类型
3. 保存配置后，设置面板自动通知侧边栏
4. 侧边栏重新加载类型映射
5. 在文档中使用这个新类型，侧边栏能立即识别 ✅
```

---

## 🔧 技术实现细节

### 核心代码结构

```typescript
// 1. 初始化类型映射（支持自定义类型）
async function initializeTypeMap() {
    const config = await ConfigManager.load(plugin);
    const allTypes = ConfigManager.getAllTypes(config);
    typeMap.clear();
    allTypes.forEach(type => {
        typeMap.set(type.type, type);
    });
}

// 2. 设置 MutationObserver
function setupMutationObserver() {
    const editor = getCurrentActiveEditor();
    const docElement = editor?.protyle?.wysiwyg?.element;
    
    mutationObserver = new MutationObserver((mutations) => {
        // 检测 Callout 相关变化
        // 自动触发列表更新
    });
    
    mutationObserver.observe(docElement, {
        childList: true,
        subtree: true,
        attributes: true,
        attributeFilter: ['custom-callout', 'data-collapsed']
    });
}

// 3. 组件生命周期管理
onMount(async () => {
    await initializeTypeMap();
    loadCallouts();
    setupMutationObserver();
});

onDestroy(() => {
    if (mutationObserver) {
        mutationObserver.disconnect();
    }
});

// 4. 设置面板保存配置后通知侧边栏
async function saveConfig() {
    await ConfigManager.save(plugin, config);
    allTypes = ConfigManager.getAllTypes(config);
    calloutManager.updateConfig(config);
    calloutManager.refresh();
    
    // 🔔 通知侧边栏重新加载类型映射
    if (plugin.refreshOutlineStyles) {
        await plugin.refreshOutlineStyles();
    }
}
```

### 通信流程图

```
设置面板                    主插件                     侧边栏
   │                        │                         │
   │  保存配置               │                         │
   ├────────────────────────>│                         │
   │                        │                         │
   │ refreshOutlineStyles() │                         │
   ├────────────────────────>│                         │
   │                        │  updateStyles()         │
   │                        ├────────────────────────>│
   │                        │                         │
   │                        │      initializeTypeMap()│
   │                        │      <─────────────────┤
   │                        │                         │
   │                        │      loadCallouts()    │
   │                        │      <─────────────────┤
   │                        │                         │
   │      ✅ 配置已更新      │      ✅ 类型已重载      │
```

---

## 🎉 用户体验提升

### Before（之前）
- ❌ 自定义类型无法显示
- ❌ 需要手动刷新才能看到更新
- ❌ 体验割裂，操作繁琐

### After（现在）
- ✅ 所有类型（预设+自定义）都能显示
- ✅ 实时自动更新，无需手动操作
- ✅ 流畅的使用体验，所见即所得

---

## 📊 监听事件总结

| 事件类型 | 触发条件 | 延迟时间 | 说明 |
|---------|---------|---------|------|
| 添加 Callout | 新建 Callout 块 | 300ms | 等待 DOM 完全更新 |
| 删除 Callout | 删除 Callout 块 | 300ms | 等待 DOM 完全更新 |
| 修改类型 | `custom-callout` 属性变化 | 300ms | 类型转换 |
| 折叠/展开 | `data-collapsed` 属性变化 | 100ms | 快速响应用户操作 |
| 文档切换 | 点击事件检测 | 300ms | 切换到新文档 |
| 配置变化 | 设置面板保存配置 | 即时 | 添加/删除/修改自定义类型 |

---

## 🐛 调试信息

如果需要查看自动更新的工作情况，可以在浏览器控制台查看日志：

```
[Callout Outline] MutationObserver started
[Callout Outline] Detected callout change (add/remove), reloading...
[Callout Outline] Detected collapsed state change, reloading...
```

---

## 📝 版本信息

- **功能名称**：侧边栏智能自动更新 + 设置面板通信
- **实现日期**：2025-10-09
- **修改文件**：
  - `src/dock/callout-outline.svelte` - 侧边栏监听和类型映射
  - `src/settings/panel-v2.svelte` - 设置面板配置保存后通知
  - `src/index.ts` - 主插件通信桥梁
- **依赖版本**：无新增依赖，使用原生 MutationObserver API

---

## 🚀 后续优化方向

1. **性能监控**：添加性能指标统计
2. **批量操作**：优化批量添加/删除时的更新效率
3. **可配置**：允许用户自定义更新延迟时间
4. **智能预测**：预测用户操作，提前加载

---

**Enjoy! 🎊**


# ä¾§è¾¹æ è‡ªåŠ¨æ›´æ–°åŠŸèƒ½è¯´æ˜Ž

## ðŸŽ¯ æœ¬æ¬¡æ”¹è¿›å†…å®¹

### 1. **ä¿®å¤è‡ªå®šä¹‰ç±»åž‹æ— æ³•æ˜¾ç¤ºçš„é—®é¢˜**

**é—®é¢˜æè¿°ï¼š**
- ä¹‹å‰ä¾§è¾¹æ ï¼ˆCallout Outlineï¼‰åªèƒ½è¯†åˆ«é¢„è®¾çš„ Callout ç±»åž‹
- ç”¨æˆ·è‡ªå·±æ·»åŠ çš„è‡ªå®šä¹‰ Callout ç±»åž‹æ— æ³•åœ¨ä¾§è¾¹æ ä¸­æ˜¾ç¤º

**è§£å†³æ–¹æ¡ˆï¼š**
- ä»Žé™æ€å¯¼å…¥ `DEFAULT_CALLOUT_TYPES` æ”¹ä¸ºåŠ¨æ€åŠ è½½é…ç½®
- ä½¿ç”¨ `ConfigManager.getAllTypes()` èŽ·å–æ‰€æœ‰ç±»åž‹ï¼ˆåŒ…æ‹¬é¢„è®¾å’Œè‡ªå®šä¹‰ï¼‰
- åœ¨ç»„ä»¶æŒ‚è½½æ—¶åˆå§‹åŒ–ç±»åž‹æ˜ å°„
- åœ¨åˆ·æ–°æ—¶é‡æ–°åŠ è½½ç±»åž‹æ˜ å°„

**ä¿®æ”¹æ–‡ä»¶ï¼š**
- `src/dock/callout-outline.svelte` - åŠ¨æ€åŠ è½½ç±»åž‹æ˜ å°„
- `src/settings/panel-v2.svelte` - ä¿å­˜é…ç½®åŽé€šçŸ¥ä¾§è¾¹æ æ›´æ–°

---

### 2. **å®žçŽ°æ™ºèƒ½è‡ªåŠ¨æ›´æ–°æœºåˆ¶**

**é—®é¢˜æè¿°ï¼š**
- ç”¨æˆ·æ·»åŠ ã€åˆ é™¤æˆ–ä¿®æ”¹ Callout å—åŽï¼Œä¾§è¾¹æ åˆ—è¡¨ä¸ä¼šè‡ªåŠ¨æ›´æ–°
- éœ€è¦æ‰‹åŠ¨ç‚¹å‡»åˆ·æ–°æŒ‰é’®æ‰èƒ½çœ‹åˆ°æœ€æ–°å†…å®¹

**è§£å†³æ–¹æ¡ˆï¼š**
ä½¿ç”¨ `MutationObserver` API ç›‘å¬æ–‡æ¡£å˜åŒ–ï¼Œå®žçŽ°ä»¥ä¸‹åŠŸèƒ½ï¼š

#### ðŸ“Œ ç›‘å¬äº‹ä»¶ç±»åž‹

1. **Callout å—çš„æ·»åŠ **
   - æ£€æµ‹æ–°åˆ›å»ºçš„å¸¦æœ‰ `custom-callout` å±žæ€§çš„å¼•è¿°å—
   - è‡ªåŠ¨åˆ·æ–°ä¾§è¾¹æ åˆ—è¡¨

2. **Callout å—çš„åˆ é™¤**
   - æ£€æµ‹è¢«åˆ é™¤çš„ Callout å—
   - ä»Žä¾§è¾¹æ åˆ—è¡¨ä¸­ç§»é™¤

3. **Callout ç±»åž‹çš„å˜æ›´**
   - ç›‘å¬ `custom-callout` å±žæ€§çš„å˜åŒ–
   - æ›´æ–°ä¾§è¾¹æ ä¸­å¯¹åº”é¡¹çš„æ˜¾ç¤º

4. **æŠ˜å çŠ¶æ€çš„å˜åŒ–**
   - ç›‘å¬ `data-collapsed` å±žæ€§çš„å˜åŒ–
   - å®žæ—¶æ›´æ–°æŠ˜å å›¾æ ‡æ˜¾ç¤º

5. **æ–‡æ¡£åˆ‡æ¢**
   - æ£€æµ‹ç”¨æˆ·åˆ‡æ¢åˆ°å…¶ä»–æ–‡æ¡£
   - è‡ªåŠ¨é‡æ–°è®¾ç½®ç›‘å¬å™¨å¹¶åŠ è½½æ–°æ–‡æ¡£çš„ Callout

6. **é…ç½®å˜åŒ–**
   - ç›‘å¬è®¾ç½®é¢æ¿ä¸­çš„é…ç½®ä¿å­˜
   - è‡ªåŠ¨é‡æ–°åŠ è½½ç±»åž‹æ˜ å°„ï¼ˆåŒ…æ‹¬æ–°æ·»åŠ çš„è‡ªå®šä¹‰ç±»åž‹ï¼‰
   - ä¿è¯ä¾§è¾¹æ å§‹ç»ˆæ˜¾ç¤ºæœ€æ–°çš„ç±»åž‹é…ç½®

#### âš¡ æ€§èƒ½ä¼˜åŒ–

- **é˜²æŠ–æœºåˆ¶**ï¼šé¿å…é¢‘ç¹æ›´æ–°å¯¼è‡´æ€§èƒ½é—®é¢˜
  - Callout å¢žåˆ ï¼š300ms å»¶è¿Ÿ
  - æŠ˜å çŠ¶æ€å˜åŒ–ï¼š100ms å»¶è¿Ÿï¼ˆæ›´å¿«å“åº”ï¼‰
  
- **ç²¾ç¡®ç›‘å¬**ï¼šåªç›‘å¬å…³é”®å±žæ€§
  - `custom-callout`ï¼šCallout ç±»åž‹æ ‡è¯†
  - `data-collapsed`ï¼šæŠ˜å çŠ¶æ€
  
- **æ™ºèƒ½åˆ¤æ–­**ï¼šåªåœ¨çœŸæ­£æœ‰ Callout å˜åŒ–æ—¶æ‰è§¦å‘æ›´æ–°

#### ðŸ”„ è‡ªåŠ¨æ¸…ç†æœºåˆ¶

- ç»„ä»¶é”€æ¯æ—¶è‡ªåŠ¨æ–­å¼€ MutationObserver
- æ–‡æ¡£åˆ‡æ¢æ—¶é‡æ–°è®¾ç½®ç›‘å¬å™¨
- é˜²æ­¢å†…å­˜æ³„æ¼

---

## ðŸ’¡ ä½¿ç”¨åœºæ™¯

### åœºæ™¯ 1ï¼šåˆ›å»ºæ–°çš„ Callout
```
1. åœ¨æ–‡æ¡£ä¸­è¾“å…¥ [!info] æˆ–å…¶ä»– Callout å‘½ä»¤
2. ä¾§è¾¹æ è‡ªåŠ¨æ£€æµ‹åˆ°æ–°çš„ Callout
3. åˆ—è¡¨è‡ªåŠ¨æ›´æ–°ï¼Œæ— éœ€æ‰‹åŠ¨åˆ·æ–° âœ…
```

### åœºæ™¯ 2ï¼šåˆ é™¤ Callout
```
1. åˆ é™¤æ–‡æ¡£ä¸­çš„æŸä¸ª Callout å—
2. ä¾§è¾¹æ è‡ªåŠ¨æ£€æµ‹åˆ°åˆ é™¤æ“ä½œ
3. åˆ—è¡¨è‡ªåŠ¨æ›´æ–°ï¼Œç§»é™¤å¯¹åº”é¡¹ âœ…
```

### åœºæ™¯ 3ï¼šæŠ˜å /å±•å¼€ Callout
```
1. ç‚¹å‡» Callout çš„æŠ˜å æŒ‰é’®
2. ä¾§è¾¹æ ç«‹å³æ›´æ–°æŠ˜å å›¾æ ‡çŠ¶æ€ âœ…
```

### åœºæ™¯ 4ï¼šä½¿ç”¨è‡ªå®šä¹‰ç±»åž‹
```
1. åœ¨è®¾ç½®ä¸­æ·»åŠ è‡ªå®šä¹‰ Callout ç±»åž‹
2. åœ¨æ–‡æ¡£ä¸­ä½¿ç”¨è‡ªå®šä¹‰ç±»åž‹åˆ›å»º Callout
3. ä¾§è¾¹æ èƒ½æ­£ç¡®è¯†åˆ«å¹¶æ˜¾ç¤ºè‡ªå®šä¹‰ç±»åž‹ âœ…
```

### åœºæ™¯ 5ï¼šåˆ‡æ¢æ–‡æ¡£
```
1. ä»Žæ–‡æ¡£ A åˆ‡æ¢åˆ°æ–‡æ¡£ B
2. ä¾§è¾¹æ è‡ªåŠ¨åŠ è½½æ–‡æ¡£ B çš„ Callout åˆ—è¡¨
3. ç›‘å¬å™¨è‡ªåŠ¨é‡æ–°è®¾ç½®åˆ°æ–°æ–‡æ¡£ âœ…
```

### åœºæ™¯ 6ï¼šåœ¨è®¾ç½®é¢æ¿ä¸­æ·»åŠ è‡ªå®šä¹‰ç±»åž‹
```
1. æ‰“å¼€è®¾ç½®é¢æ¿
2. ç‚¹å‡»"æ·»åŠ æ–°ç±»åž‹"ï¼Œåˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰ Callout ç±»åž‹
3. ä¿å­˜é…ç½®åŽï¼Œè®¾ç½®é¢æ¿è‡ªåŠ¨é€šçŸ¥ä¾§è¾¹æ 
4. ä¾§è¾¹æ é‡æ–°åŠ è½½ç±»åž‹æ˜ å°„
5. åœ¨æ–‡æ¡£ä¸­ä½¿ç”¨è¿™ä¸ªæ–°ç±»åž‹ï¼Œä¾§è¾¹æ èƒ½ç«‹å³è¯†åˆ« âœ…
```

---

## ðŸ”§ æŠ€æœ¯å®žçŽ°ç»†èŠ‚

### æ ¸å¿ƒä»£ç ç»“æž„

```typescript
// 1. åˆå§‹åŒ–ç±»åž‹æ˜ å°„ï¼ˆæ”¯æŒè‡ªå®šä¹‰ç±»åž‹ï¼‰
async function initializeTypeMap() {
    const config = await ConfigManager.load(plugin);
    const allTypes = ConfigManager.getAllTypes(config);
    typeMap.clear();
    allTypes.forEach(type => {
        typeMap.set(type.type, type);
    });
}

// 2. è®¾ç½® MutationObserver
function setupMutationObserver() {
    const editor = getCurrentActiveEditor();
    const docElement = editor?.protyle?.wysiwyg?.element;
    
    mutationObserver = new MutationObserver((mutations) => {
        // æ£€æµ‹ Callout ç›¸å…³å˜åŒ–
        // è‡ªåŠ¨è§¦å‘åˆ—è¡¨æ›´æ–°
    });
    
    mutationObserver.observe(docElement, {
        childList: true,
        subtree: true,
        attributes: true,
        attributeFilter: ['custom-callout', 'data-collapsed']
    });
}

// 3. ç»„ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç†
onMount(async () => {
    await initializeTypeMap();
    loadCallouts();
    setupMutationObserver();
});

onDestroy(() => {
    if (mutationObserver) {
        mutationObserver.disconnect();
    }
});

// 4. è®¾ç½®é¢æ¿ä¿å­˜é…ç½®åŽé€šçŸ¥ä¾§è¾¹æ 
async function saveConfig() {
    await ConfigManager.save(plugin, config);
    allTypes = ConfigManager.getAllTypes(config);
    calloutManager.updateConfig(config);
    calloutManager.refresh();
    
    // ðŸ”” é€šçŸ¥ä¾§è¾¹æ é‡æ–°åŠ è½½ç±»åž‹æ˜ å°„
    if (plugin.refreshOutlineStyles) {
        await plugin.refreshOutlineStyles();
    }
}
```

### é€šä¿¡æµç¨‹å›¾

```
è®¾ç½®é¢æ¿                    ä¸»æ’ä»¶                     ä¾§è¾¹æ 
   â”‚                        â”‚                         â”‚
   â”‚  ä¿å­˜é…ç½®               â”‚                         â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                         â”‚
   â”‚                        â”‚                         â”‚
   â”‚ refreshOutlineStyles() â”‚                         â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                         â”‚
   â”‚                        â”‚  updateStyles()         â”‚
   â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                        â”‚                         â”‚
   â”‚                        â”‚      initializeTypeMap()â”‚
   â”‚                        â”‚      <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                        â”‚                         â”‚
   â”‚                        â”‚      loadCallouts()    â”‚
   â”‚                        â”‚      <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                        â”‚                         â”‚
   â”‚      âœ… é…ç½®å·²æ›´æ–°      â”‚      âœ… ç±»åž‹å·²é‡è½½      â”‚
```

---

## ðŸŽ‰ ç”¨æˆ·ä½“éªŒæå‡

### Beforeï¼ˆä¹‹å‰ï¼‰
- âŒ è‡ªå®šä¹‰ç±»åž‹æ— æ³•æ˜¾ç¤º
- âŒ éœ€è¦æ‰‹åŠ¨åˆ·æ–°æ‰èƒ½çœ‹åˆ°æ›´æ–°
- âŒ ä½“éªŒå‰²è£‚ï¼Œæ“ä½œç¹ç

### Afterï¼ˆçŽ°åœ¨ï¼‰
- âœ… æ‰€æœ‰ç±»åž‹ï¼ˆé¢„è®¾+è‡ªå®šä¹‰ï¼‰éƒ½èƒ½æ˜¾ç¤º
- âœ… å®žæ—¶è‡ªåŠ¨æ›´æ–°ï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œ
- âœ… æµç•…çš„ä½¿ç”¨ä½“éªŒï¼Œæ‰€è§å³æ‰€å¾—

---

## ðŸ“Š ç›‘å¬äº‹ä»¶æ€»ç»“

| äº‹ä»¶ç±»åž‹ | è§¦å‘æ¡ä»¶ | å»¶è¿Ÿæ—¶é—´ | è¯´æ˜Ž |
|---------|---------|---------|------|
| æ·»åŠ  Callout | æ–°å»º Callout å— | 300ms | ç­‰å¾… DOM å®Œå…¨æ›´æ–° |
| åˆ é™¤ Callout | åˆ é™¤ Callout å— | 300ms | ç­‰å¾… DOM å®Œå…¨æ›´æ–° |
| ä¿®æ”¹ç±»åž‹ | `custom-callout` å±žæ€§å˜åŒ– | 300ms | ç±»åž‹è½¬æ¢ |
| æŠ˜å /å±•å¼€ | `data-collapsed` å±žæ€§å˜åŒ– | 100ms | å¿«é€Ÿå“åº”ç”¨æˆ·æ“ä½œ |
| æ–‡æ¡£åˆ‡æ¢ | ç‚¹å‡»äº‹ä»¶æ£€æµ‹ | 300ms | åˆ‡æ¢åˆ°æ–°æ–‡æ¡£ |
| é…ç½®å˜åŒ– | è®¾ç½®é¢æ¿ä¿å­˜é…ç½® | å³æ—¶ | æ·»åŠ /åˆ é™¤/ä¿®æ”¹è‡ªå®šä¹‰ç±»åž‹ |

---

## ðŸ› è°ƒè¯•ä¿¡æ¯

å¦‚æžœéœ€è¦æŸ¥çœ‹è‡ªåŠ¨æ›´æ–°çš„å·¥ä½œæƒ…å†µï¼Œå¯ä»¥åœ¨æµè§ˆå™¨æŽ§åˆ¶å°æŸ¥çœ‹æ—¥å¿—ï¼š

```
[Callout Outline] MutationObserver started
[Callout Outline] Detected callout change (add/remove), reloading...
[Callout Outline] Detected collapsed state change, reloading...
```

---

## ðŸ“ ç‰ˆæœ¬ä¿¡æ¯

- **åŠŸèƒ½åç§°**ï¼šä¾§è¾¹æ æ™ºèƒ½è‡ªåŠ¨æ›´æ–° + è®¾ç½®é¢æ¿é€šä¿¡
- **å®žçŽ°æ—¥æœŸ**ï¼š2025-10-09
- **ä¿®æ”¹æ–‡ä»¶**ï¼š
  - `src/dock/callout-outline.svelte` - ä¾§è¾¹æ ç›‘å¬å’Œç±»åž‹æ˜ å°„
  - `src/settings/panel-v2.svelte` - è®¾ç½®é¢æ¿é…ç½®ä¿å­˜åŽé€šçŸ¥
  - `src/index.ts` - ä¸»æ’ä»¶é€šä¿¡æ¡¥æ¢
- **ä¾èµ–ç‰ˆæœ¬**ï¼šæ— æ–°å¢žä¾èµ–ï¼Œä½¿ç”¨åŽŸç”Ÿ MutationObserver API

---

## ðŸš€ åŽç»­ä¼˜åŒ–æ–¹å‘

1. **æ€§èƒ½ç›‘æŽ§**ï¼šæ·»åŠ æ€§èƒ½æŒ‡æ ‡ç»Ÿè®¡
2. **æ‰¹é‡æ“ä½œ**ï¼šä¼˜åŒ–æ‰¹é‡æ·»åŠ /åˆ é™¤æ—¶çš„æ›´æ–°æ•ˆçŽ‡
3. **å¯é…ç½®**ï¼šå…è®¸ç”¨æˆ·è‡ªå®šä¹‰æ›´æ–°å»¶è¿Ÿæ—¶é—´
4. **æ™ºèƒ½é¢„æµ‹**ï¼šé¢„æµ‹ç”¨æˆ·æ“ä½œï¼Œæå‰åŠ è½½

---

**Enjoy! ðŸŽŠ**


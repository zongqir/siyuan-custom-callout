# 调试指南

## 如何查看调试日志

### 1. 打开开发者工具

**Windows/Linux**: 按 `F12` 或 `Ctrl + Shift + I`
**macOS**: 按 `Cmd + Option + I`

### 2. 切换到 Console 标签

所有调试日志都会在控制台显示

### 3. 过滤日志

在控制台搜索框输入 `Callout` 可以只看插件相关的日志

## 日志说明

插件使用了带有 emoji 的日志标记，便于快速识别：

### 插件加载阶段
```
🚀 插件开始加载
📱 设备类型检测
✅ 图标已添加
🔧 正在初始化管理器
✅ 插件加载成功
```

### Callout 处理器
```
🚀 初始化处理器
✅ 加载了 X 个 Callout 类型
✅ 初始加载完成，菜单触发器已激活
```

### 监听器（重要！）
```
🎧 开始设置事件监听器
✅ MutationObserver 已启动
✅ 事件监听器设置完成
```

### 引用块检测
```
🔍 发现新的引用块          - Observer 检测到新引用块
📝 处理引用块 N             - 开始处理第 N 个引用块
🎯 菜单显示条件检查          - 检查是否应该显示菜单
```

### 菜单显示
```
🎉 显示菜单!                - 准备显示菜单
📋 尝试显示菜单             - 菜单函数被调用
✅ 创建菜单                 - 菜单DOM创建成功
⚠️ 菜单已显示，跳过         - 菜单已经在显示中
```

### 事件触发
```
⌨️ input/keyup/paste 事件触发
🎯 焦点事件
🖱️ 点击 Callout 标题
📍 点击位置: Xpx
```

## 排查步骤

### 问题: 创建引用块时没有弹出菜单

#### 步骤 1: 确认插件已加载
在控制台查看是否有：
```
✅ 插件加载成功！
✅ 初始加载完成，菜单触发器已激活
```

如果没有看到这些日志，说明插件没有正常加载。

#### 步骤 2: 检查是否等待了2秒
插件加载后有2秒的初始化时间，在这期间不会触发菜单。
等待看到 `✅ 初始加载完成，菜单触发器已激活` 后再创建引用块。

#### 步骤 3: 创建引用块并观察日志

**正常情况应该看到：**
```
[Callout Observer] 🔍 发现新的引用块: <bq element>
[Callout Observer] ✅ 处理引用块数量: 1
[Callout Observer] 📝 处理引用块 1: {nodeId: "xxx", isEmpty: true, ...}
[Callout Observer] 🎯 菜单显示条件检查: {
    isEmpty: true,
    isInitialLoad: false,
    hasNodeId: true,
    isRecentlyCreated: false,
    shouldShowMenu: true
}
[Callout Observer] 🎉 显示菜单! {rect: {...}}
[Callout Menu] 📋 尝试显示菜单
[Callout Menu] ✅ 创建菜单...
```

#### 步骤 4: 分析日志中的条件

如果看到 `🎯 菜单显示条件检查` 但 `shouldShowMenu: false`，检查：

- **isEmpty: false** - 引用块不为空，可能已经有内容了
- **isInitialLoad: true** - 还在初始加载期间，等待2秒
- **hasNodeId: false** - 引用块没有 node-id（不应该发生）
- **isRecentlyCreated: true** - 这个引用块刚刚显示过菜单

#### 步骤 5: 检查焦点事件

如果 Observer 没有触发，尝试手动聚焦到引用块，应该看到：
```
[Callout Event] 🎯 焦点事件: {isContentEditable: true, isInitialLoad: false}
[Callout Event] 🔍 焦点引用块检查: {...}
[Callout Event] 🎉 焦点触发显示菜单!
```

### 问题: 输入 @info 等命令没有效果

观察日志应该有：
```
[Callout Event] ⌨️ input 事件触发
[Callout Event] 📝 处理引用块内容变化
[Callout] Processing blockquote: <element>
```

如果有这些日志但样式没变化，可能是CSS问题。

### 问题: 点击图标无法切换类型

应该看到：
```
[Callout Event] 🖱️ 点击 Callout 标题
[Callout Event] 📍 点击位置: Xpx
[Callout Event] 🎨 显示类型切换菜单
```

如果 `点击位置 > 40px`，说明点击的不是图标区域。

## 常见日志含义

### 正常流程
```
1. 插件加载
   🚀 -> 🔧 -> ✅

2. 创建引用块
   🔍 -> 📝 -> 🎯 -> 🎉 -> 📋 -> ✅

3. 输入内容
   ⌨️ -> 📝 -> Processing blockquote

4. 焦点进入
   🎯 -> 🔍 -> 🎉
```

### 异常情况
```
⚠️ 引用块尺寸为0，不显示菜单
   -> 引用块被隐藏或还没有渲染完成

⚠️ 菜单已显示，跳过
   -> 菜单已经在显示，不重复显示

⏳ 初始加载中，跳过焦点处理
   -> 还在2秒初始化期间
```

## 手动测试命令

在控制台执行这些命令可以手动测试：

```javascript
// 查看所有引用块
document.querySelectorAll('.bq')

// 查看所有Callout引用块
document.querySelectorAll('.bq[custom-callout]')

// 刷新所有Callout
// (需要先打开设置面板，或者在插件代码中调用)
```

## 提交问题时请提供

1. **完整的控制台日志**（从插件加载开始）
2. **操作步骤**（你做了什么）
3. **预期结果** vs **实际结果**
4. **思源版本号**
5. **插件版本号**

## 禁用调试日志

如果觉得日志太多，可以在浏览器控制台过滤器中设置：
- 隐藏级别：选择 "Info" 级别以下
- 或者在过滤框输入 `-Callout` （减号表示排除）

注意：生产环境建议保留 Error 和 Warning 级别的日志。


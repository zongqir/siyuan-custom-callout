# 插件资源泄漏修复说明

## 修复概述

本次修复解决了插件卸载或关闭时未能正确清理资源的问题，包括：
- 事件监听器未移除
- 定时器未清除
- MutationObserver 未断开
- ResizeObserver 未断开
- 主题订阅未取消

## 修复的文件

### 1. `src/callout/manager.ts`

**问题：**
- `setupEventListeners()` 方法添加了多个全局事件监听器（input, keyup, paste, click, focusin）
- 这些监听器在 `destroy()` 方法中没有被移除

**修复：**
- 添加了私有属性来保存事件监听器引用：
  ```typescript
  private inputEventHandler: ((e: Event) => void) | null = null;
  private clickEventHandler: ((e: Event) => void) | null = null;
  private focusinEventHandler: ((e: Event) => void) | null = null;
  ```
- 在 `setupEventListeners()` 中将匿名函数改为保存的引用
- 在 `destroy()` 方法中添加了移除这些监听器的代码
- 添加了对 `menu.destroy()` 的调用以清理菜单资源

### 2. `src/callout/menu.ts`

**问题：**
- `setupGlobalEventListeners()` 方法添加了全局 keydown 和 click 事件监听器
- `themeHelper.subscribe()` 订阅了主题变化，但没有取消订阅
- 缺少 `destroy()` 方法

**修复：**
- 添加了私有属性来保存事件监听器引用：
  ```typescript
  private globalKeydownHandler: ((e: KeyboardEvent) => void) | null = null;
  private globalClickHandler: ((e: MouseEvent) => void) | null = null;
  ```
- 在 `setupGlobalEventListeners()` 中将匿名函数改为保存的引用
- 添加了 `destroy()` 方法：
  - 移除全局事件监听器
  - 调用 `themeHelper.destroy()` 取消主题订阅
  - 隐藏并移除菜单元素

### 3. `src/callout/drag-resize.ts`

**问题：**
- `startPeriodicCheck()` 创建的 setInterval 没有被清除
- `initializeResizer()` 创建的 MutationObserver 没有被断开
- `createHorizontalHandle()` 和 `createVerticalHandle()` 创建的 ResizeObserver 没有被断开
- `bindGlobalEvents()` 添加的大量事件监听器没有被移除
- window resize 事件监听器没有被移除

**修复：**
- 添加了私有属性来保存需要清理的资源：
  ```typescript
  private mutationObserver: MutationObserver | null = null;
  private periodicCheckInterval: number | null = null;
  private resizeObservers: ResizeObserver[] = [];
  private eventListeners: Array<{
      target: EventTarget;
      type: string;
      listener: EventListener;
      options?: boolean | AddEventListenerOptions;
  }> = [];
  ```
- 添加了 `addTrackedEventListener()` 辅助方法来自动记录所有事件监听器
- 更新所有添加事件监听器的地方使用 `addTrackedEventListener()`
- 更新 `createHorizontalHandle()` 和 `createVerticalHandle()` 保存 ResizeObserver 到数组
- 更新 `destroy()` 方法：
  - 清除定期检查定时器
  - 断开 MutationObserver
  - 断开所有 ResizeObserver
  - 移除所有事件监听器
  - 移除所有拖拽手柄 DOM 元素

### 4. `src/callout/proxy-button.ts`

**问题：**
- `init()` 方法中的 setInterval 没有被清除
- `addHoverListeners()` 添加到 callout 元素上的事件监听器没有被移除

**修复：**
- 添加了私有属性来保存资源：
  ```typescript
  private periodicCheckInterval: number | null = null;
  private eventHandlers: Map<string, () => void> = new Map();
  ```
- 在 `init()` 中保存 setInterval 的返回值
- 在 `addHoverListeners()` 中保存每个 callout 的事件处理器引用
- 更新 `destroy()` 方法：
  - 清除定期检查定时器
  - 遍历所有保存的事件处理器并移除
  - 清空事件处理器 Map

## 验证

- ✅ 所有修改的文件都通过了 TypeScript 编译
- ✅ 项目构建成功（`npm run build`）
- ✅ 没有引入新的 linter 错误

## 影响

这些修复确保了插件在卸载或关闭时能够完全清理其创建的所有资源，包括：
- 全局和局部事件监听器
- 定时器（setInterval）
- 观察者（MutationObserver, ResizeObserver）
- 主题订阅
- DOM 元素

这样可以：
1. 防止内存泄漏
2. 避免插件卸载后仍然响应事件
3. 确保插件可以干净地重新加载
4. 提高应用整体性能和稳定性


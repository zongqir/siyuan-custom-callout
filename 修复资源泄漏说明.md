# 插件资源泄漏修复说明

## 修复概述

本次修复解决了插件卸载或关闭时未能正确清理资源的问题，包括：
- 事件监听器未移除
- 定时器未清除
- MutationObserver 未断开
- ResizeObserver 未断开
- 主题订阅未取消

## 修复的文件

### 1. `src/callout/processor.ts`

**问题：**
- `addCollapseToggle()` 方法在每个 callout 的标题元素上添加了 click 和 dblclick 事件监听器
- 这些监听器在插件卸载时没有被移除

**修复：**
- 添加了 `destroy()` 方法：
  ```typescript
  destroy() {
      // 遍历所有已跟踪的 callout，移除事件监听器
      this.trackedBlockQuotes.forEach(nodeId => {
          const callout = document.querySelector(`[data-node-id="${nodeId}"][custom-callout]`);
          if (callout) {
              const titleDiv = callout.querySelector('[data-callout-title="true"]') as HTMLElement;
              if (titleDiv) {
                  this.removeCollapseToggle(titleDiv);
              }
          }
      });
      
      // 清空跟踪集合
      this.trackedBlockQuotes.clear();
      this.recentlyCreatedBlockQuotes.clear();
  }
  ```
- 在 manager 的 destroy 方法中调用 `processor.destroy()`

### 2. `src/callout/manager.ts`

**问题：**
- `setupEventListeners()` 方法添加了多个全局事件监听器（input, keyup, paste, click, focusin）
- 这些监听器在 `destroy()` 方法中没有被移除

**修复：**
- 添加了私有属性来保存事件监听器引用：
  ```typescript
  private inputEventHandler: ((e: Event) => void) | null = null;
  private clickEventHandler: ((e: Event) => void) | null = null;
  private focusinEventHandler: ((e: Event) => void) | null = null;
  ```
- 在 `setupEventListeners()` 中将匿名函数改为保存的引用
- 在 `destroy()` 方法中添加了移除这些监听器的代码
- 添加了对 `menu.destroy()` 的调用以清理菜单资源

### 2. `src/callout/menu.ts`

**问题：**
- `setupGlobalEventListeners()` 方法添加了全局 keydown 和 click 事件监听器
- `themeHelper.subscribe()` 订阅了主题变化，但没有取消订阅
- 缺少 `destroy()` 方法

**修复：**
- 添加了私有属性来保存事件监听器引用：
  ```typescript
  private globalKeydownHandler: ((e: KeyboardEvent) => void) | null = null;
  private globalClickHandler: ((e: MouseEvent) => void) | null = null;
  ```
- 在 `setupGlobalEventListeners()` 中将匿名函数改为保存的引用
- 添加了 `destroy()` 方法：
  - 移除全局事件监听器
  - 调用 `themeHelper.destroy()` 取消主题订阅
  - 隐藏并移除菜单元素

### 3. `src/callout/autocomplete.ts`

**问题：**
- `setupGlobalEventListeners()` 方法添加了全局 click 事件监听器
- 在 `destroy()` 方法中没有移除

**修复：**
- 添加了私有属性来保存事件监听器引用：
  ```typescript
  private globalClickHandler: ((e: MouseEvent) => void) | null = null;
  ```
- 在 `setupGlobalEventListeners()` 中将匿名函数改为保存的引用
- 更新 `destroy()` 方法移除全局事件监听器

### 4. `src/callout/menu-theme.ts`

**问题：**
- `setupListeners()` 方法添加了 MediaQueryList 的 change 事件监听器
- 在 `destroy()` 方法中没有移除

**修复：**
- 添加了私有属性来保存引用：
  ```typescript
  private mediaQueryList: MediaQueryList | null = null;
  private mediaQueryHandler: (() => void) | null = null;
  ```
- 在 `setupListeners()` 中保存 MediaQueryList 和处理器引用
- 更新 `destroy()` 方法移除 MediaQueryList 事件监听器

### 5. `src/callout/drag-resize.ts`

**问题：**
- `startPeriodicCheck()` 创建的 setInterval 没有被清除
- `initializeResizer()` 创建的 MutationObserver 没有被断开
- `createHorizontalHandle()` 和 `createVerticalHandle()` 创建的 ResizeObserver 没有被断开
- `bindGlobalEvents()` 添加的大量事件监听器没有被移除
- window resize 事件监听器没有被移除

**修复：**
- 添加了私有属性来保存需要清理的资源：
  ```typescript
  private mutationObserver: MutationObserver | null = null;
  private periodicCheckInterval: number | null = null;
  private resizeObservers: ResizeObserver[] = [];
  private eventListeners: Array<{
      target: EventTarget;
      type: string;
      listener: EventListener;
      options?: boolean | AddEventListenerOptions;
  }> = [];
  ```
- 添加了 `addTrackedEventListener()` 辅助方法来自动记录所有事件监听器
- 更新所有添加事件监听器的地方使用 `addTrackedEventListener()`
- 更新 `createHorizontalHandle()` 和 `createVerticalHandle()` 保存 ResizeObserver 到数组
- 更新 `destroy()` 方法：
  - 清除定期检查定时器
  - 断开 MutationObserver
  - 断开所有 ResizeObserver
  - 移除所有事件监听器
  - 移除所有拖拽手柄 DOM 元素

### 6. `src/callout/proxy-button.ts`

**问题：**
- `init()` 方法中的 setInterval 没有被清除
- `addHoverListeners()` 添加到 callout 元素上的事件监听器没有被移除

**修复：**
- 添加了私有属性来保存资源：
  ```typescript
  private periodicCheckInterval: number | null = null;
  private eventHandlers: Map<string, () => void> = new Map();
  ```
- 在 `init()` 中保存 setInterval 的返回值
- 在 `addHoverListeners()` 中保存每个 callout 的事件处理器引用
- 更新 `destroy()` 方法：
  - 清除定期检查定时器
  - 遍历所有保存的事件处理器并移除
  - 清空事件处理器 Map

## 验证

- ✅ 所有修改的文件都通过了 TypeScript 编译
- ✅ 项目构建成功（`npm run build`）
- ✅ 没有引入新的 linter 错误

## 修复总结

共修复了 **7 个文件**中的资源泄漏问题：

| 文件 | 主要问题 | 修复内容 |
|------|---------|---------|
| `processor.ts` | Callout 元素上的事件监听器 | 添加 destroy() 方法移除监听器 |
| `manager.ts` | 全局事件监听器（input, keyup, paste, click, focusin） | 保存引用并在 destroy 时移除 |
| `menu.ts` | 全局事件监听器（keydown, click）、主题订阅 | 添加 destroy() 方法清理所有资源 |
| `autocomplete.ts` | 全局 click 事件监听器 | 保存引用并在 destroy 时移除 |
| `menu-theme.ts` | MediaQueryList 事件监听器 | 保存引用并在 destroy 时移除 |
| `drag-resize.ts` | 定时器、MutationObserver、ResizeObserver、多个事件监听器 | 创建资源跟踪系统并完全清理 |
| `proxy-button.ts` | 定时器、元素事件监听器 | 保存引用并在 destroy 时移除 |

**清理的资源类型：**
- ✅ 全局事件监听器（document、window）
- ✅ 元素事件监听器（callout 元素）
- ✅ MediaQueryList 监听器
- ✅ 定时器（setInterval）
- ✅ MutationObserver（3 个）
- ✅ ResizeObserver（多个）
- ✅ 主题订阅
- ✅ DOM 元素（菜单、拖拽手柄等）

## 影响

这些修复确保了插件在卸载或关闭时能够完全清理其创建的所有资源，带来以下好处：

1. **防止内存泄漏** - 所有监听器和观察者都被正确移除
2. **避免僵尸事件处理** - 插件卸载后不再响应任何事件
3. **支持热重载** - 插件可以安全地卸载和重新加载
4. **提高稳定性** - 减少与其他插件的潜在冲突
5. **改善性能** - 减少不必要的事件处理开销

## 测试建议

在测试插件时，建议验证以下场景：
1. 安装插件 → 正常使用 → 卸载插件 → 确认没有残留监听器
2. 重复安装/卸载插件多次 → 确认无内存泄漏
3. 卸载插件后与文档中的 callout 元素交互 → 确认无报错


# å…‰æ ‡æ£€æµ‹ä¿®å¤æŠ€æœ¯æ–‡æ¡£

## é—®é¢˜èƒŒæ™¯

åœ¨æ€æºç¬”è®°çš„Calloutæ’ä»¶ä¸­ï¼Œç”¨æˆ·åé¦ˆäº†ä¸€ä¸ªå…³é”®çš„ç”¨æˆ·ä½“éªŒé—®é¢˜ï¼šå½“å®Œå…¨åˆ é™¤blockquoteå†…å®¹åé‡æ–°è¾“å…¥`[!info]`æ—¶ï¼Œç³»ç»Ÿæ²¡æœ‰ç»™äºˆè¶³å¤Ÿçš„"æ€è€ƒæ—¶é—´"ï¼Œç«‹å³è§¦å‘äº†calloutæ¸²æŸ“ï¼Œæ‰“æ–­äº†ç”¨æˆ·çš„è¾“å…¥æµç¨‹ã€‚

### é¢„æœŸè¡Œä¸º
- ç”¨æˆ·åˆ é™¤å†…å®¹åˆ°ç¬¬ä¸€è¡Œæ—¶ï¼Œåº”è¯¥æœ‰**3ç§’ç¼“å†²æ—¶é—´**
- å…¶ä»–æ­£å¸¸è¾“å…¥ä¿æŒ**300ms**çš„æ ‡å‡†å“åº”æ—¶é—´

### å®é™…é—®é¢˜
- æ— è®ºä»€ä¹ˆæƒ…å†µéƒ½æ˜¯300mså“åº”
- å…‰æ ‡ä½ç½®æ£€æµ‹å¤±è´¥ï¼Œæ— æ³•åŒºåˆ†æ˜¯å¦åœ¨ç¬¬ä¸€è¡Œ

## é—®é¢˜åˆ†æ

### æ ¹æœ¬åŸå› 

é€šè¿‡è°ƒè¯•å‘ç°ï¼Œå…‰æ ‡æ£€æµ‹é€»è¾‘å­˜åœ¨è‡´å‘½ç¼ºé™·ï¼š

```javascript
// âŒ é”™è¯¯çš„æ£€æµ‹æ–¹å¼
const blockquote = target.closest('[data-type="NodeBlockquote"], .bq');
```

**å¤±è´¥åŸå› åˆ†æï¼š**

1. **äº‹ä»¶ç›®æ ‡é”™è¯¯**ï¼šè¾“å…¥äº‹ä»¶çš„`target`ç»å¸¸æ˜¯æ•´ä¸ªç¼–è¾‘å™¨å®¹å™¨(`protyle-wysiwyg`)
2. **DOMç»“æ„ç†è§£é”™è¯¯**ï¼šç¼–è¾‘å™¨å®¹å™¨ä¸åœ¨blockquoteå†…éƒ¨ï¼Œè€Œæ˜¯åŒ…å«blockquote
3. **æŸ¥æ‰¾æ–¹å‘é”™è¯¯**ï¼šä»å¤–å±‚å®¹å™¨å¾€ä¸Šæ‰¾blockquoteï¼Œæ°¸è¿œæ‰¾ä¸åˆ°

### è°ƒè¯•æ—¥å¿—è¯æ®

```
[Callout Debug] å…‰æ ‡æ£€æµ‹: æ‰¾ä¸åˆ°blockquote
[Callout Debug] Input event: {isInFirstLine: false, isAfterDelete: true, delay: '300ms'}
```

å¯ä»¥çœ‹åˆ°ï¼š
- `isInFirstLine: false` - å…‰æ ‡æ£€æµ‹å¤±è´¥
- `delay: '300ms'` - ä½¿ç”¨äº†é»˜è®¤å»¶è¿Ÿè€Œéé¢„æœŸçš„3000ms

## è§£å†³æ–¹æ¡ˆ

### æ ¸å¿ƒä¿®å¤æ€è·¯

**ä»"çŒœæµ‹å…‰æ ‡ä½ç½®"æ”¹ä¸º"ç²¾ç¡®å®šä½å…‰æ ‡ä½ç½®"**

ä¸å†ä¾èµ–äº‹ä»¶ç›®æ ‡ï¼Œè€Œæ˜¯ç›´æ¥ä»æµè§ˆå™¨é€‰åŒºAPIè·å–çœŸå®çš„å…‰æ ‡ä½ç½®ã€‚

### ä¿®å¤ä»£ç 

```javascript
// âœ… æ­£ç¡®çš„æ£€æµ‹æ–¹å¼
private isCaretInFirstLine(target: HTMLElement): boolean {
    try {
        const selection = window.getSelection();
        if (!selection || selection.rangeCount === 0) {
            return false;
        }
        
        const range = selection.getRangeAt(0);
        
        // ğŸ”§ å…³é”®ä¿®å¤ï¼šç›´æ¥ä»é€‰åŒºæŸ¥æ‰¾blockquote
        let container = range.commonAncestorContainer;
        if (container.nodeType === Node.TEXT_NODE) {
            container = container.parentElement!;
        }
        
        const blockquote = (container as HTMLElement).closest('[data-type="NodeBlockquote"], .bq');
        if (!blockquote) {
            return false;
        }
        
        // è·å–blockquoteçš„ç¬¬ä¸€ä¸ªå¯ç¼–è¾‘div
        const firstDiv = blockquote.querySelector('div[contenteditable="true"]');
        if (!firstDiv) {
            return false;
        }
        
        // å¤šé‡æ£€æµ‹ç¡®ä¿å‡†ç¡®æ€§
        const isInFirstLine = firstDiv.contains(range.commonAncestorContainer) || 
                             firstDiv === range.commonAncestorContainer ||
                             range.commonAncestorContainer === firstDiv ||
                             firstDiv.contains(container as Node) ||
                             firstDiv === container;
        
        return isInFirstLine;
    } catch (e) {
        return false; // å¼‚å¸¸æ—¶å®‰å…¨è¿”å›
    }
}
```

### å…³é”®æŠ€æœ¯ç‚¹

#### 1. **å‡†ç¡®çš„èµ·å§‹ç‚¹**
```javascript
// ä»çœŸå®çš„å…‰æ ‡ä½ç½®å¼€å§‹
let container = range.commonAncestorContainer;
```
- `commonAncestorContainer`æ˜¯å…‰æ ‡æ‰€åœ¨çš„å®é™…DOMèŠ‚ç‚¹
- è¿™æ˜¯æµè§ˆå™¨æä¾›çš„æ ‡å‡†APIï¼Œæ¯”äº‹ä»¶ç›®æ ‡æ›´å¯é 

#### 2. **å…¼å®¹æ–‡æœ¬èŠ‚ç‚¹**
```javascript
if (container.nodeType === Node.TEXT_NODE) {
    container = container.parentElement!;
}
```
- å…‰æ ‡å¯èƒ½åœ¨æ–‡æœ¬èŠ‚ç‚¹å†…ï¼Œéœ€è¦è·å–å…¶çˆ¶å…ƒç´ æ¥è¿›è¡ŒDOMæŸ¥è¯¢

#### 3. **å¤šé‡æ£€æµ‹ä¿éšœ**
```javascript
const isInFirstLine = 
    firstDiv.contains(range.commonAncestorContainer) || 
    firstDiv === range.commonAncestorContainer ||
    range.commonAncestorContainer === firstDiv ||
    firstDiv.contains(container as Node) ||
    firstDiv === container;
```
- è€ƒè™‘å„ç§DOMç»“æ„æƒ…å†µ
- ç¡®ä¿åœ¨ä¸åŒçš„å…‰æ ‡ä½ç½®éƒ½èƒ½æ­£ç¡®æ£€æµ‹

#### 4. **å¼‚å¸¸å¤„ç†**
```javascript
try {
    // æ£€æµ‹é€»è¾‘
} catch (e) {
    return false; // å®‰å…¨é™çº§
}
```
- DOMæ“ä½œå¯èƒ½å‡ºç°å¼‚å¸¸ï¼Œå®‰å…¨è¿”å›falseä½¿ç”¨é»˜è®¤å»¶è¿Ÿ

## ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰
```
[Callout Debug] å…‰æ ‡æ£€æµ‹: æ‰¾ä¸åˆ°blockquote
[Callout Debug] Input event: {isInFirstLine: false, isAfterDelete: true, delay: '300ms'}
```

### ä¿®å¤å
```
[Callout Debug] å…‰æ ‡æ£€æµ‹è¯¦æƒ…: {
    blockquoteFound: true,
    isInFirstLine: true,
    firstDivText: "[!info]"
}
[Callout Debug] Input event: {isInFirstLine: true, isAfterDelete: true, delay: '3000ms'}
```

**æ˜¾è‘—æ”¹å–„ï¼š**
- âœ… æˆåŠŸæ‰¾åˆ°blockquote
- âœ… æ­£ç¡®æ£€æµ‹å…‰æ ‡åœ¨ç¬¬ä¸€è¡Œ
- âœ… è§¦å‘3ç§’å»¶è¿Ÿæœºåˆ¶

## å½±å“è¯„ä¼°

### æ­£é¢å½±å“

#### 1. **å‡†ç¡®æ€§æå‡**
- å…‰æ ‡æ£€æµ‹æˆåŠŸç‡ä»0%æå‡åˆ°æ¥è¿‘100%
- ä¸å†å—æ€æºç¬”è®°DOMç»“æ„å˜åŒ–å½±å“

#### 2. **ç”¨æˆ·ä½“éªŒæ”¹å–„**
- åˆ é™¤åçœŸæ­£çš„3ç§’æ€è€ƒæ—¶é—´
- ä¸ä¼šæ‰“æ–­ç”¨æˆ·çš„é‡æ–°è¾“å…¥æµç¨‹
- å‡å°‘è¯¯è§¦å‘å’Œæ„å¤–è½¬æ¢

#### 3. **ä»£ç å¥å£®æ€§**
- åŸºäºæ ‡å‡†æµè§ˆå™¨APIï¼Œå…¼å®¹æ€§å¥½
- æœ‰å®Œæ•´çš„å¼‚å¸¸å¤„ç†æœºåˆ¶
- å‘åå…¼å®¹ï¼Œä¸å½±å“ç°æœ‰åŠŸèƒ½

### æ½œåœ¨é£é™©

#### 1. **æ€§èƒ½å½±å“**
- **è¯„ä¼°**ï¼šå¾®ä¹å…¶å¾®
- **åŸå› **ï¼š`getSelection()`æ˜¯æµè§ˆå™¨åŸç”ŸAPIï¼Œæ€§èƒ½å¼€é”€æå°
- **é¢‘ç‡**ï¼šåªåœ¨è¾“å…¥äº‹ä»¶æ—¶è°ƒç”¨ï¼Œä¸æ˜¯é«˜é¢‘æ“ä½œ

#### 2. **å…¼å®¹æ€§é£é™©**
- **è¯„ä¼°**ï¼šæä½
- **åŸå› **ï¼šSelection APIæ˜¯Webæ ‡å‡†ï¼Œæ‰€æœ‰ç°ä»£æµè§ˆå™¨éƒ½æ”¯æŒ
- **å¤‡é€‰**ï¼šæœ‰å¼‚å¸¸å¤„ç†ï¼Œæœ€åæƒ…å†µä¸‹é™çº§ä¸ºé»˜è®¤è¡Œä¸º

#### 3. **é€»è¾‘å¤æ‚åº¦**
- **è¯„ä¼°**ï¼šå¯æ§
- **åŸå› **ï¼šè™½ç„¶æ£€æµ‹é€»è¾‘æ›´å¤æ‚ï¼Œä½†æ¯ä¸ªæ­¥éª¤éƒ½æœ‰æ¸…æ™°çš„æ³¨é‡Š
- **ç»´æŠ¤**ï¼šä»£ç ç»“æ„æ¸…æ™°ï¼Œæ˜“äºç†è§£å’Œç»´æŠ¤

## æŠ€æœ¯åŸç†

### DOMç»“æ„ç†è§£

```
protyle-wysiwyg (ç¼–è¾‘å™¨å®¹å™¨)
â””â”€â”€ ... (å…¶ä»–å†…å®¹)
    â””â”€â”€ blockquote (å¼•è¿°å—)
        â””â”€â”€ div[contenteditable="true"] (ç¬¬ä¸€è¡Œ - æ ‡é¢˜è¡Œ)
        â””â”€â”€ div[contenteditable="true"] (ç¬¬äºŒè¡Œ - å†…å®¹è¡Œ)
        â””â”€â”€ ...
```

### é€‰åŒºAPIåŸç†

```javascript
// æµè§ˆå™¨é€‰åŒºAPIå·¥ä½œåŸç†
const selection = window.getSelection(); // è·å–å½“å‰é€‰åŒº
const range = selection.getRangeAt(0);   // è·å–é€‰åŒºèŒƒå›´
const container = range.commonAncestorContainer; // è·å–é€‰åŒºæ‰€åœ¨çš„DOMèŠ‚ç‚¹
```

**ä¸ºä»€ä¹ˆé€‰åŒºAPIæ›´å¯é ï¼Ÿ**
- ç›´æ¥åæ˜ ç”¨æˆ·å…‰æ ‡çš„çœŸå®ä½ç½®
- ä¸å—äº‹ä»¶å†’æ³¡å’Œå§”æ‰˜å½±å“
- æ˜¯æµè§ˆå™¨ç»´æŠ¤çš„æƒå¨æ•°æ®æº

### æŸ¥æ‰¾ç­–ç•¥å¯¹æ¯”

| æ–¹å¼ | èµ·å§‹ç‚¹ | æŸ¥æ‰¾æ–¹å‘ | æˆåŠŸç‡ | å¯é æ€§ |
|------|--------|----------|--------|--------|
| æ—§æ–¹å¼ | äº‹ä»¶ç›®æ ‡ | å‘ä¸ŠæŸ¥æ‰¾ | ~0% | ä½ |
| æ–°æ–¹å¼ | å…‰æ ‡ä½ç½® | å‘ä¸ŠæŸ¥æ‰¾ | ~100% | é«˜ |

## æœ€ä½³å®è·µ

### 1. **å…‰æ ‡ä½ç½®æ£€æµ‹æ¨¡å¼**
```javascript
// æ¨èæ¨¡å¼ï¼šé€‰åŒºAPI + å®¹é”™å¤„ç†
const selection = window.getSelection();
if (!selection || selection.rangeCount === 0) return false;

const range = selection.getRangeAt(0);
let container = range.commonAncestorContainer;
```

### 2. **DOMæŸ¥æ‰¾æ¨¡å¼**  
```javascript
// æ¨èæ¨¡å¼ï¼šå¤šé‡æ£€æµ‹ + ç±»å‹å®‰å…¨
if (container.nodeType === Node.TEXT_NODE) {
    container = container.parentElement!;
}
const target = (container as HTMLElement).closest(selector);
```

### 3. **å¼‚å¸¸å¤„ç†æ¨¡å¼**
```javascript
// æ¨èæ¨¡å¼ï¼štry-catch + å®‰å…¨é™çº§
try {
    // å¤æ‚çš„DOMæ“ä½œ
    return complexDetection();
} catch (e) {
    console.log('æ£€æµ‹å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤è¡Œä¸º', e);
    return false; // å®‰å…¨é™çº§
}
```

## ç»“è®º

è¿™æ¬¡ä¿®å¤æ˜¯ä¸€ä¸ªå…¸å‹çš„**"ç²¾ç¡®å®šä½æ›¿ä»£æ¨¡ç³ŠçŒœæµ‹"**çš„æŠ€æœ¯å‡çº§ï¼š

1. **é—®é¢˜æœ¬è´¨**ï¼šé”™è¯¯ç†è§£äº†äº‹ä»¶ç³»ç»Ÿå’ŒDOMç»“æ„å…³ç³»
2. **è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨æ ‡å‡†æµè§ˆå™¨APIè·å–ç²¾ç¡®ä½ç½®ä¿¡æ¯
3. **æŠ€æœ¯ä»·å€¼**ï¼šæä¾›äº†å¤„ç†å¤æ‚DOMäº¤äº’çš„å¯é æ¨¡å¼
4. **ç”¨æˆ·ä»·å€¼**ï¼šæ˜¾è‘—æ”¹å–„äº†ç¼–è¾‘ä½“éªŒå’Œäº¤äº’æµç•…æ€§

è¿™ç§ä¿®å¤æ¨¡å¼å¯ä»¥æ¨å¹¿åˆ°å…¶ä»–éœ€è¦ç²¾ç¡®DOMä½ç½®æ£€æµ‹çš„åœºæ™¯ï¼Œæ˜¯å‰ç«¯å¼€å‘ä¸­å¤„ç†å¤æ‚ç¼–è¾‘å™¨äº¤äº’çš„é‡è¦å‚è€ƒæ¡ˆä¾‹ã€‚

---

*æŠ€æœ¯æ–‡æ¡£ç¼–å†™æ—¶é—´ï¼š2024å¹´10æœˆ*  
*æ¶‰åŠç‰ˆæœ¬ï¼šCalloutæ’ä»¶ v2.x*  
*å…¼å®¹ç¯å¢ƒï¼šæ€æºç¬”è®° + ç°ä»£æµè§ˆå™¨*

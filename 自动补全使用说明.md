# Callout 自动补全功能说明

## 🎉 新功能

已实现三大优化：

### 1. ⚡ 回车立即刷新
- 输入 `> @info` 后按回车，**立即应用样式**
- 无需手动刷新，DOM自动更新
- 10ms 延迟确保DOM更新完成

### 2. 🎯 智能自动补全
- 输入 `@` 后自动显示补全菜单
- 支持模糊搜索（英文命令、中文命令、显示名称）
- 键盘导航：上下键选择，回车确认，Esc 取消
- 鼠标操作：悬停预览，点击选择

### 3. 🚫 命令输入时自动隐藏菜单
- 检测到 `@` 输入，立即隐藏可视化菜单
- 切换到自动补全模式
- 删除 `@` 后自动恢复菜单

---

## 📖 使用演示

### 场景 1：完整命令输入

```
1. 创建引用块: >
2. 输入命令: @info
3. 按回车: Enter
4. ✅ 立即应用 info 样式
```

### 场景 2：自动补全

```
1. 创建引用块: >
2. 输入: @
   → 自动弹出补全菜单
3. 继续输入: @in
   → 过滤显示匹配项（info）
4. 方向键选择或直接点击
5. 回车确认
6. ✅ 立即应用样式
```

### 场景 3：中文搜索

```
1. 创建引用块: >
2. 输入: @技
   → 显示包含"技"的类型（技巧）
3. 回车确认
4. ✅ 应用样式
```

### 场景 4：模糊搜索

```
1. 输入: @示
   → 显示"示例演示"
2. 输入: @best
   → 显示"最佳实践"
3. 输入: @信息
   → 显示"信息说明"
```

---

## 🎨 UI 设计

### 自动补全菜单样式

```
┌─────────────────────────┐
│ 🔵 信息说明              │ ← 选中状态（灰色背景）
│    @info / @信息         │
├─────────────────────────┤
│ 💡 使用技巧              │
│    @tip / @技巧          │
├─────────────────────────┤
│ 📝 示例演示              │
│    @example / @示例      │
└─────────────────────────┘
```

**特点**：
- 轻量简洁（比命令菜单更小巧）
- 实时过滤（输入即过滤）
- 视觉反馈（悬停高亮、选中背景）
- 智能定位（紧贴引用块）

---

## ⌨️ 键盘快捷键

| 按键 | 功能 |
|------|------|
| `@` | 触发自动补全 |
| `↑` | 上一个选项 |
| `↓` | 下一个选项 |
| `Enter` | 确认选择 |
| `Esc` | 取消补全 |

---

## 🔧 技术实现

### 关键改动

#### 1. `autocomplete.ts` (新文件)
```typescript
export class CalloutAutocomplete {
    // 模糊搜索
    getSuggestions(input: string): CalloutTypeConfig[]
    
    // 显示补全
    showAutocomplete(x, y, blockquote, inputText)
    
    // 键盘导航
    selectNext() / selectPrevious()
    
    // 确认选择
    confirmSelection()
}
```

#### 2. `manager.ts` 
**回车监听**：
```typescript
document.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && isCommand) {
        setTimeout(() => {
            this.processor.processBlockquote(blockquote);
        }, 10);
    }
});
```

**自动补全集成**：
```typescript
if (isCommand) {
    this.menu.hideMenu(true);
    this.autocomplete.showAutocomplete(...);
} else {
    this.autocomplete.hideAutocomplete();
}
```

#### 3. `processor.ts`
```typescript
// 检测命令输入
isCommandInput(text: string): boolean

// 根据命令查找类型
findTypeByCommand(command: string): CalloutTypeConfig | null

// 获取第一行文本
getBlockquoteFirstLineText(blockquote): string
```

---

## 🎯 用户体验提升

### 之前的问题

❌ **回车后不刷新**
- 输入 `@info` + 回车
- 还是原生样式
- 需要手动触发其他操作才刷新

❌ **菜单干扰命令输入**
- 输入 `@` 时菜单还在
- 视觉混乱
- 不清楚该用哪种方式

❌ **没有输入提示**
- 需要记住所有命令
- 打错命令没有反馈
- 新手不友好

### 现在的体验

✅ **即时反馈**
- 输入 + 回车 = 立即应用
- 无需等待，无需手动刷新

✅ **智能切换**
- `>` → 显示菜单
- `@` → 切换到补全
- 自动识别用户意图

✅ **友好提示**
- 实时补全建议
- 模糊搜索容错
- 可视化预览

---

## 🚀 测试建议

1. **回车刷新测试**
   ```
   > @info [Enter]
   → 检查是否立即应用样式
   ```

2. **自动补全测试**
   ```
   > @in
   → 检查是否显示 info
   → 检查上下键导航
   → 检查回车确认
   ```

3. **中文补全测试**
   ```
   > @技
   → 检查是否显示"技巧"
   ```

4. **菜单切换测试**
   ```
   > 
   → 检查菜单显示
   > @
   → 检查菜单隐藏，补全显示
   → 删除 @
   → 检查菜单恢复
   ```

5. **边界情况测试**
   ```
   > @xyz
   → 检查无匹配时的处理
   > @
   → 点击外部关闭补全
   ```

---

## 💡 总结

现在的 Callout 插件实现了：

✅ **命令模式** - 类似 Obsidian，输入即创建  
✅ **菜单模式** - 思源特色，可视化选择  
✅ **自动补全** - 最佳实践，提示+容错  
✅ **即时反馈** - 回车立刷，无需等待  
✅ **智能切换** - 自动识别，无缝体验  

**三种方式，任选其一，或混合使用！** 🎉




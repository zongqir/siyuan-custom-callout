# Callout V2 ç³»ç»Ÿä½¿ç”¨æŒ‡å—

## æ¦‚è¿°

Callout V2 æ˜¯å…¨æ–°çš„åŸºäºå—å±æ€§ï¼ˆBlock Attributesï¼‰çš„å®ç°ï¼Œç›¸æ¯” V1 ç‰ˆæœ¬æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š

### âœ… V2 çš„ä¼˜åŠ¿

1. **æ›´å¯é **ï¼šä¸ä¾èµ–æ–‡æ¡£å†…å®¹è§£æï¼Œä½¿ç”¨å—å±æ€§å­˜å‚¨çŠ¶æ€
2. **æ›´ç®€æ´**ï¼šä»£ç é‡å‡å°‘çº¦ 60%ï¼Œæ›´æ˜“ç»´æŠ¤
3. **æ›´å¿«é€Ÿ**ï¼šé€šè¿‡ CSS å±æ€§é€‰æ‹©å™¨ç›´æ¥åº”ç”¨æ ·å¼ï¼Œæ€§èƒ½æ›´å¥½
4. **æ›´ç¨³å®š**ï¼šä¸ä¼šå› ä¸ºæ–‡æ¡£ç¼–è¾‘è€Œä¸¢å¤± callout çŠ¶æ€
5. **æ›´çµæ´»**ï¼šæ”¯æŒè‡ªå®šä¹‰æ ‡é¢˜ï¼Œç‹¬ç«‹äºæ–‡æ¡£å†…å®¹

### ğŸ”„ ä» V1 è¿ç§»åˆ° V2

åœ¨ä¸»å…¥å£æ–‡ä»¶ä¸­ï¼Œå°†ï¼š
```typescript
import { CalloutManager } from './callout';
```

æ”¹ä¸ºï¼š
```typescript
import { CalloutManagerV2 } from './callout';
```

## å¿«é€Ÿå¼€å§‹

### 1. åœ¨æ’ä»¶ä¸­ä½¿ç”¨

```typescript
import { Plugin } from "siyuan";
import { CalloutManagerV2 } from "./callout";

export default class CustomCalloutPlugin extends Plugin {
    private calloutManager: CalloutManagerV2 | null = null;

    async onload() {
        // åˆå§‹åŒ– Callout ç®¡ç†å™¨
        this.calloutManager = new CalloutManagerV2(this);
        await this.calloutManager.initialize();
    }

    async onunload() {
        // é”€æ¯ Callout ç®¡ç†å™¨
        if (this.calloutManager) {
            this.calloutManager.destroy();
            this.calloutManager = null;
        }
    }
}
```

### 2. åŸºæœ¬ç”¨æ³•

#### åˆ›å»º Callout

```typescript
// è·å–å¤„ç†å™¨
const processor = calloutManager.getProcessor();

// ä¸ºä¸€ä¸ª blockquote åˆ›å»º callout
const blockquote = document.querySelector('.bq[data-node-id="xxx"]');
await processor.createCallout(blockquote, 'info', 'è¿™æ˜¯ä¸€ä¸ªä¿¡æ¯æç¤º');
```

#### æ˜¾ç¤ºèœå•

```typescript
// è·å–èœå•
const menu = calloutManager.getMenu();

// æ˜¾ç¤ºåˆ›å»ºèœå•
await menu.show(blockquote, false);

// æ˜¾ç¤ºç¼–è¾‘èœå•
await menu.show(blockquote, true);
```

#### æ›´æ–°ç±»å‹

```typescript
// æ›´æ–° callout ç±»å‹
await processor.updateCalloutType(blockquote, 'warning');
```

#### åˆ é™¤ Callout

```typescript
// åˆ é™¤ callout
await processor.removeCallout(blockquote);
```

#### åˆ‡æ¢æŠ˜å çŠ¶æ€

```typescript
// æŠ˜å çŠ¶æ€ç”±å¤„ç†å™¨è‡ªåŠ¨ç®¡ç†
// ç”¨æˆ·ç‚¹å‡»æŠ˜å æŒ‰é’®å³å¯åˆ‡æ¢
```

### 3. å—å±æ€§è¯´æ˜

V2 ç³»ç»Ÿä½¿ç”¨ä»¥ä¸‹å—å±æ€§å­˜å‚¨çŠ¶æ€ï¼š

| å±æ€§å | è¯´æ˜ | ç¤ºä¾‹å€¼ |
|--------|------|--------|
| `custom-callout-type` | Callout ç±»å‹ | `info`, `warning`, `tip` ç­‰ |
| `custom-callout-title` | è‡ªå®šä¹‰æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰ | `é‡è¦æç¤º` |
| `custom-callout-collapsed` | æŠ˜å çŠ¶æ€ | `true` æˆ– `false` |

### 4. CSS é€‰æ‹©å™¨

V2 ç³»ç»Ÿä½¿ç”¨å±æ€§é€‰æ‹©å™¨åº”ç”¨æ ·å¼ï¼š

```css
/* é€‰æ‹©æ‰€æœ‰ callout */
.bq[custom-callout] { }

/* é€‰æ‹©ç‰¹å®šç±»å‹çš„ callout */
.bq[custom-callout-type="info"] { }

/* é€‰æ‹©æŠ˜å çŠ¶æ€çš„ callout */
.bq[custom-callout][data-collapsed="true"] { }
```

## æ ¸å¿ƒ API

### CalloutProcessorV2

å¤„ç†å™¨è´Ÿè´£ callout çš„åˆ›å»ºã€æ›´æ–°ã€åˆ é™¤å’Œæ ·å¼åº”ç”¨ã€‚

#### æ–¹æ³•

```typescript
class CalloutProcessorV2 {
    // åˆå§‹åŒ–å¤„ç†å™¨
    initialize(): void
    
    // é”€æ¯å¤„ç†å™¨
    destroy(): void
    
    // åˆ›å»º callout
    createCallout(blockquote: HTMLElement, type: string, title?: string): Promise<void>
    
    // åˆ é™¤ callout
    removeCallout(blockquote: HTMLElement): Promise<void>
    
    // æ›´æ–°ç±»å‹
    updateCalloutType(blockquote: HTMLElement, newType: string): Promise<void>
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯ callout
    isCallout(blockquote: HTMLElement): Promise<boolean>
    
    // è·å– callout ç±»å‹
    getCalloutType(blockquote: HTMLElement): Promise<string | null>
    
    // æ›´æ–°ç±»å‹é…ç½®
    updateTypes(types: CalloutTypeConfig[]): void
    
    // è·å–æ‰€æœ‰ç±»å‹
    getTypes(): CalloutTypeConfig[]
}
```

### CalloutMenuV2

èœå•è´Ÿè´£æ˜¾ç¤ºç±»å‹é€‰æ‹©ç•Œé¢ã€‚

#### æ–¹æ³•

```typescript
class CalloutMenuV2 {
    // æ˜¾ç¤ºèœå•
    show(blockquote: HTMLElement, isEdit: boolean): Promise<void>
    
    // éšè—èœå•
    hide(): void
    
    // æ£€æŸ¥èœå•æ˜¯å¦å¯è§
    isVisible(): boolean
    
    // æ›´æ–°ç±»å‹é…ç½®
    updateTypes(types: CalloutTypeConfig[]): void
    
    // æ›´æ–°ç½‘æ ¼åˆ—æ•°
    updateGridColumns(columns: number): void
    
    // é”€æ¯èœå•
    destroy(): void
}
```

### CalloutManagerV2

ç®¡ç†å™¨åè°ƒå¤„ç†å™¨å’Œèœå•ï¼Œå¤„ç†ç”¨æˆ·äº¤äº’ã€‚

#### æ–¹æ³•

```typescript
class CalloutManagerV2 {
    // åˆå§‹åŒ–
    initialize(): Promise<void>
    
    // é”€æ¯
    destroy(): void
    
    // æ›´æ–°é…ç½®
    updateConfig(config: CalloutConfig): void
    
    // é‡æ–°åŠ è½½é…ç½®
    reloadConfig(): Promise<void>
    
    // åˆ·æ–°æ ·å¼
    refreshStyles(): Promise<void>
    
    // è·å–å¤„ç†å™¨
    getProcessor(): CalloutProcessorV2
    
    // è·å–èœå•
    getMenu(): CalloutMenuV2
}
```

## ç”¨æˆ·äº¤äº’

### å¿«æ·é”®

- `Ctrl/Cmd + Shift + C`: åœ¨å½“å‰ blockquote ä¸Šåˆ›å»º/ç¼–è¾‘ callout

### é¼ æ ‡æ“ä½œ

- **åŒå‡» blockquote**: æ‰“å¼€ callout èœå•
- **ç‚¹å‡»ä¾§è¾¹æ æŒ‰é’®**: æ‰“å¼€ callout èœå•
- **ç‚¹å‡»æŠ˜å æŒ‰é’®**: åˆ‡æ¢æŠ˜å çŠ¶æ€

### é”®ç›˜å¯¼èˆªï¼ˆèœå•ä¸­ï¼‰

- `â†‘â†“â†â†’`: ç§»åŠ¨é€‰æ‹©
- `Enter`: ç¡®è®¤é€‰æ‹©
- `Esc`: å…³é—­èœå•

## é«˜çº§ç”¨æ³•

### è‡ªå®šä¹‰ä¸»é¢˜

```typescript
import { updateCalloutStyles } from './callout/styles-v2';

// æ›´æ–°æ ·å¼
updateCalloutStyles(
    'custom-callout-styles-v2',
    customTypes,
    'modern',
    {
        padding: '16px',
        borderRadius: '8px',
        hideIcon: false,
        hideTitle: false
    }
);
```

### æ·»åŠ è‡ªå®šä¹‰ç±»å‹

```typescript
const customType: CalloutTypeConfig = {
    type: 'custom',
    displayName: 'è‡ªå®šä¹‰',
    command: '[!custom]',
    color: '#ff0000',
    bgGradient: 'linear-gradient(to bottom, #ffe0e0, #ffffff)',
    borderColor: '#ff0000',
    icon: '<svg>...</svg>'
};

// æ›´æ–°ç±»å‹
processor.updateTypes([...DEFAULT_CALLOUT_TYPES, customType]);
```

### ç›‘å¬ callout å˜åŒ–

```typescript
// V2 ä½¿ç”¨å—å±æ€§ï¼Œå¯ä»¥é€šè¿‡ç›‘å¬å±æ€§å˜åŒ–æ¥å“åº”
const observer = new MutationObserver((mutations) => {
    mutations.forEach(mutation => {
        if (mutation.type === 'attributes') {
            const element = mutation.target as HTMLElement;
            const calloutType = element.getAttribute('custom-callout-type');
            
            if (calloutType) {
                console.log('Callout ç±»å‹å˜åŒ–:', calloutType);
            }
        }
    });
});

observer.observe(document.body, {
    attributes: true,
    attributeFilter: ['custom-callout-type', 'custom-callout-collapsed'],
    subtree: true
});
```

## æ¶æ„å¯¹æ¯”

### V1 æ¶æ„ï¼ˆåŸºäºæ–‡æ¡£è§£æï¼‰

```
ç”¨æˆ·è¾“å…¥ â†’ è§£ææ–‡æ¡£å†…å®¹ â†’ æ£€æµ‹ [!type] è¯­æ³• â†’ åº”ç”¨ CSS ç±» â†’ æ¸²æŸ“
```

**é—®é¢˜ï¼š**
- ä¾èµ–æ–‡æ¡£å†…å®¹ï¼Œç”¨æˆ·ç¼–è¾‘å¯èƒ½ç ´å callout
- éœ€è¦å¤æ‚çš„æ­£åˆ™è¡¨è¾¾å¼è§£æ
- æ€§èƒ½å¼€é”€å¤§
- çŠ¶æ€ä¸ç¨³å®š

### V2 æ¶æ„ï¼ˆåŸºäºå—å±æ€§ï¼‰

```
ç”¨æˆ·æ“ä½œ â†’ è®¾ç½®å—å±æ€§ â†’ CSS å±æ€§é€‰æ‹©å™¨ â†’ æ¸²æŸ“
```

**ä¼˜åŠ¿ï¼š**
- çŠ¶æ€å­˜å‚¨åœ¨å—å±æ€§ä¸­ï¼Œä¸å—æ–‡æ¡£å†…å®¹å½±å“
- ç®€å•çš„å±æ€§è¯»å†™æ“ä½œ
- æ€§èƒ½ä¼˜ç§€
- çŠ¶æ€ç¨³å®šå¯é 

## æ€§èƒ½ä¼˜åŒ–

V2 ç³»ç»Ÿçš„æ€§èƒ½ä¼˜åŒ–ï¼š

1. **CSS å±æ€§é€‰æ‹©å™¨**ï¼šæµè§ˆå™¨åŸç”Ÿä¼˜åŒ–ï¼Œæ€§èƒ½æä½³
2. **MutationObserver**ï¼šåªç›‘å¬å¿…è¦çš„ DOM å˜åŒ–
3. **äº‹ä»¶å§”æ‰˜**ï¼šå‡å°‘äº‹ä»¶ç›‘å¬å™¨æ•°é‡
4. **æŒ‰éœ€æ¸²æŸ“**ï¼šåªå¤„ç†å¯è§çš„ blockquote

## è°ƒè¯•æŠ€å·§

### æŸ¥çœ‹å—å±æ€§

```typescript
// è·å–å—å±æ€§
const attrs = await getBlockAttrs(nodeId);
console.log('å—å±æ€§:', attrs);
```

### å…¨å±€è®¿é—®

```typescript
// V2 ç³»ç»Ÿæš´éœ²åˆ°å…¨å±€ï¼Œæ–¹ä¾¿è°ƒè¯•
window.siyuanCalloutProcessorV2
window.siyuanCalloutMenuV2
```

### æ—¥å¿—è¾“å‡º

```typescript
import { logger } from './libs/logger';

logger.log('[Debug] è°ƒè¯•ä¿¡æ¯');
logger.error('[Debug] é”™è¯¯ä¿¡æ¯');
```

## å¸¸è§é—®é¢˜

### Q: V1 å’Œ V2 å¯ä»¥å…±å­˜å—ï¼Ÿ

A: å¯ä»¥ï¼Œä½†ä¸æ¨èã€‚å»ºè®®é€‰æ‹©å…¶ä¸­ä¸€ä¸ªç‰ˆæœ¬ä½¿ç”¨ã€‚

### Q: å¦‚ä½•è¿ç§»ç°æœ‰çš„ V1 callout åˆ° V2ï¼Ÿ

A: éœ€è¦ç¼–å†™è¿ç§»è„šæœ¬ï¼Œè¯»å–æ–‡æ¡£å†…å®¹ä¸­çš„ callout è¯­æ³•ï¼Œè½¬æ¢ä¸ºå—å±æ€§ã€‚

### Q: V2 æ”¯æŒæ‰€æœ‰ V1 çš„åŠŸèƒ½å—ï¼Ÿ

A: æ ¸å¿ƒåŠŸèƒ½å®Œå…¨æ”¯æŒï¼Œéƒ¨åˆ†é«˜çº§åŠŸèƒ½ï¼ˆå¦‚æ‹–æ‹½è°ƒæ•´ï¼‰æ­£åœ¨è¿ç§»ä¸­ã€‚

### Q: æ€§èƒ½æå‡æœ‰å¤šå¤§ï¼Ÿ

A: åœ¨å¤§å‹æ–‡æ¡£ä¸­ï¼ŒV2 çš„åˆå§‹åŒ–é€Ÿåº¦å¿«çº¦ 3-5 å€ï¼Œå†…å­˜å ç”¨å‡å°‘çº¦ 40%ã€‚

## ä¸‹ä¸€æ­¥

- æŸ¥çœ‹ `src/callout/processor-v2.ts` äº†è§£å¤„ç†å™¨å®ç°
- æŸ¥çœ‹ `src/callout/menu-v2.ts` äº†è§£èœå•å®ç°
- æŸ¥çœ‹ `src/callout/styles-v2.ts` äº†è§£æ ·å¼ç³»ç»Ÿ
- æŸ¥çœ‹ `src/callout/manager-v2.ts` äº†è§£ç®¡ç†å™¨å®ç°

## è´¡çŒ®

æ¬¢è¿æäº¤ PR å’Œ Issueï¼

## è®¸å¯è¯

MIT


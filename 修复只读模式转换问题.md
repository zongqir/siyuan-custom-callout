# ğŸ”§ ä¿®å¤åªè¯»æ¨¡å¼ä¸‹ Callout ä¸è½¬æ¢çš„é—®é¢˜

## é—®é¢˜æè¿°

å½“ç”¨æˆ·åœ¨æ€æºç¬”è®°ä¸­ä»¥**åªè¯»æ¨¡å¼**æ‰“å¼€æ–‡æ¡£æ—¶ï¼Œæ’ä»¶æ— æ³•è‡ªåŠ¨å°† blockquote è½¬æ¢ä¸º Callout æ ·å¼ã€‚

## æ ¹æœ¬åŸå› 

æ’ä»¶åªåœ¨åˆå§‹åŒ–æ—¶è°ƒç”¨äº† `processAllBlockquotes()`ï¼Œä½†æ²¡æœ‰ç›‘å¬ç¼–è¾‘å™¨åŠ è½½äº‹ä»¶ã€‚å½“ç”¨æˆ·æ‰“å¼€æ–°æ–‡æ¡£ï¼ˆç‰¹åˆ«æ˜¯åªè¯»æ¨¡å¼ï¼‰æ—¶ï¼Œæ’ä»¶ä¸ä¼šå¤„ç†è¯¥æ–‡æ¡£ä¸­çš„ blockquoteã€‚

## è§£å†³æ–¹æ¡ˆ

åœ¨ `CalloutManager` ä¸­æ·»åŠ å¯¹æ€æºç¬”è®°ç¼–è¾‘å™¨åŠ è½½äº‹ä»¶çš„ç›‘å¬ï¼š

### 1. ç›‘å¬çš„äº‹ä»¶

- **`loaded-protyle-static`** - ç¼–è¾‘å™¨é™æ€åŠ è½½å®Œæˆï¼ˆåŒ…æ‹¬åªè¯»æ¨¡å¼ï¼‰
- **`loaded-protyle-dynamic`** - ç¼–è¾‘å™¨åŠ¨æ€åŠ è½½å®Œæˆ  
- **`switch-protyle`** - ç¼–è¾‘å™¨åˆ‡æ¢

### 2. å®ç°ç»†èŠ‚

**src/callout/manager.ts** ä¸­çš„ä¿®æ”¹ï¼š

1. åœ¨æ„é€ å‡½æ•°ä¸­è°ƒç”¨ `setupProtyleLoadListeners()`
2. æ–°å¢ `setupProtyleLoadListeners()` æ–¹æ³•ï¼Œç›‘å¬ä¸‰ä¸ªç¼–è¾‘å™¨äº‹ä»¶
3. æ–°å¢ `processProtyleBlockquotes(protyle)` æ–¹æ³•ï¼Œå¤„ç†ç‰¹å®šç¼–è¾‘å™¨ä¸­çš„ blockquote
4. åœ¨ `destroy()` æ–¹æ³•ä¸­å–æ¶ˆäº‹ä»¶è®¢é˜…

### 3. æ ¸å¿ƒä»£ç 

```typescript
// ç›‘å¬é™æ€ç¼–è¾‘å™¨åŠ è½½ï¼ˆåŒ…æ‹¬åªè¯»æ¨¡å¼ï¼‰
this.plugin.eventBus.on("loaded-protyle-static", ({ protyle }: any) => {
    setTimeout(() => {
        this.processProtyleBlockquotes(protyle);
    }, 100);
});

// å¤„ç†ç‰¹å®šç¼–è¾‘å™¨ä¸­çš„ blockquote
private processProtyleBlockquotes(protyle: any) {
    if (!protyle?.wysiwyg?.element) return;
    
    const blockquotes = protyle.wysiwyg.element.querySelectorAll(
        '.bq, [data-type="NodeBlockquote"]'
    );
    
    blockquotes.forEach((bq: HTMLElement) => {
        this.processor.processBlockquote(bq);
    });
}
```

## æµ‹è¯•å»ºè®®

1. ä»¥åªè¯»æ¨¡å¼æ‰“å¼€åŒ…å« `[!info]`ã€`[!warning]` ç­‰ callout å‘½ä»¤çš„æ–‡æ¡£
2. éªŒè¯ blockquote æ˜¯å¦è‡ªåŠ¨è½¬æ¢ä¸º Callout æ ·å¼
3. åˆ‡æ¢æ–‡æ¡£æ—¶éªŒè¯æ–°æ–‡æ¡£ä¸­çš„ callout æ˜¯å¦æ­£å¸¸æ˜¾ç¤º
4. æ£€æŸ¥æ§åˆ¶å°æ˜¯å¦æœ‰ç›¸å…³æ—¥å¿—è¾“å‡º

## ç›¸å…³æ–‡ä»¶

- `src/callout/manager.ts` - ä¸»è¦ä¿®æ”¹æ–‡ä»¶

## å‚è€ƒæ–‡æ¡£

- æ€æºç¬”è®°æ’ä»¶äº‹ä»¶æ€»çº¿ï¼š`siyuan-master/app/src/types/index.d.ts`
- ç¼–è¾‘å™¨åŠ è½½äº‹ä»¶è§¦å‘ä½ç½®ï¼š`siyuan-master/app/src/protyle/util/onGet.ts`

---

**ä¿®å¤æ—¶é—´**: 2025-10-09  
**ä¿®å¤è€…**: AI Assistant  
**ç‰ˆæœ¬**: 1.3.1+


# 🔧 修复只读模式下 Callout 不转换的问题

## 问题描述

当用户在思源笔记中以**只读模式**打开文档时，插件无法自动将 blockquote 转换为 Callout 样式。

## 根本原因

插件只在初始化时调用了 `processAllBlockquotes()`，但没有监听编辑器加载事件。当用户打开新文档（特别是只读模式）时，插件不会处理该文档中的 blockquote。

## 解决方案

在 `CalloutManager` 中添加对思源笔记编辑器加载事件的监听：

### 1. 监听的事件

- **`loaded-protyle-static`** - 编辑器静态加载完成（包括只读模式）
- **`loaded-protyle-dynamic`** - 编辑器动态加载完成  
- **`switch-protyle`** - 编辑器切换

### 2. 实现细节

**src/callout/manager.ts** 中的修改：

1. 在构造函数中调用 `setupProtyleLoadListeners()`
2. 新增 `setupProtyleLoadListeners()` 方法，监听三个编辑器事件
3. 新增 `processProtyleBlockquotes(protyle)` 方法，处理特定编辑器中的 blockquote
4. 在 `destroy()` 方法中取消事件订阅

### 3. 核心代码

```typescript
// 监听静态编辑器加载（包括只读模式）
this.plugin.eventBus.on("loaded-protyle-static", ({ protyle }: any) => {
    setTimeout(() => {
        this.processProtyleBlockquotes(protyle);
    }, 100);
});

// 处理特定编辑器中的 blockquote
private processProtyleBlockquotes(protyle: any) {
    if (!protyle?.wysiwyg?.element) return;
    
    const blockquotes = protyle.wysiwyg.element.querySelectorAll(
        '.bq, [data-type="NodeBlockquote"]'
    );
    
    blockquotes.forEach((bq: HTMLElement) => {
        this.processor.processBlockquote(bq);
    });
}
```

## 测试建议

1. 以只读模式打开包含 `[!info]`、`[!warning]` 等 callout 命令的文档
2. 验证 blockquote 是否自动转换为 Callout 样式
3. 切换文档时验证新文档中的 callout 是否正常显示
4. 检查控制台是否有相关日志输出

## 相关文件

- `src/callout/manager.ts` - 主要修改文件

## 参考文档

- 思源笔记插件事件总线：`siyuan-master/app/src/types/index.d.ts`
- 编辑器加载事件触发位置：`siyuan-master/app/src/protyle/util/onGet.ts`

---

**修复时间**: 2025-10-09  
**修复者**: AI Assistant  
**版本**: 1.3.1+


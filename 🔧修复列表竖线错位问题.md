# 🔧 修复列表竖线错位问题

## 问题描述

在 Callout 块中使用列表时，虽然小圆点（项目符号）可以正常显示，但是连接嵌套列表项的竖线出现了错位现象。这是因为 Callout 中使用了更紧凑的列表间距，但思源笔记原生的竖线样式使用固定值计算位置和高度，导致无法适应紧凑布局。

### 具体表现

- ✅ 列表的小圆点（disc）可以正常显示
- ✅ 有序列表的序号（decimal）可以正常显示
- ❌ 嵌套列表之间的竖线位置不正确（垂直方向错位）
- ❌ 竖线的高度与实际列表高度不匹配

## 根本原因

思源笔记使用 `::before` 伪元素为列表项（`.li` 或 `div[data-type="NodeListItem"]`）生成连接竖线。原生样式的关键代码：

```scss
&.li {
  min-height: calc(1.625em + 8px);
  
  &::before {
    content: "";
    position: absolute;
    border-left: .5px solid var(--b3-theme-background-light);
    left: 17px;
    height: calc(100% - 1em * 1.625 - 12px);  // ← 使用固定的 12px
    top: calc(1em * 1.625 + 12px);             // ← 使用固定的 12px
  }
  
  & > .protyle-action {
    height: calc(1.625em + 8px);               // ← 使用固定的 8px
    line-height: calc(1.625em + 8px);
  }
}
```

**关键问题**：
1. 竖线高度和顶部位置使用固定的 `12px` 间距
2. `.protyle-action` 高度使用固定的 `8px` 间距
3. 列表项最小高度使用固定的 `8px` 间距

但在 Callout 中，为了更紧凑的显示，我们设置了：
```css
margin: 4px 0 4px var(--callout-list-indent, 12px);
```

这导致固定值与实际间距不匹配，竖线错位。

## 修复方案

### 1. 调整列表项最小高度

```css
.protyle-wysiwyg .bq[custom-callout] div[data-type="NodeListItem"] {
    min-height: auto !important;
}
```

移除固定的最小高度限制，允许列表项根据内容自适应高度。

### 2. 调整竖线位置和高度

```css
.protyle-wysiwyg .bq[custom-callout] div[data-type="NodeListItem"]::before {
    /* 保持原生的 left 位置 */
    left: 17px !important;
    
    /* 将间距从 12px 改为 4px，匹配紧凑的 margin */
    height: calc(100% - 1em * 1.625 - 4px) !important;
    top: calc(1em * 1.625 + 4px) !important;
    
    /* 保持原生的颜色样式 */
    border-left-width: 0.5px !important;
    border-left-color: var(--b3-theme-background-light) !important;
}
```

**关键改动**：
- `height: calc(100% - 1em * 1.625 - 4px)` ← 从 `12px` 改为 `4px`
- `top: calc(1em * 1.625 + 4px)` ← 从 `12px` 改为 `4px`

这样竖线的垂直位置和高度就能匹配 `margin: 4px` 的紧凑布局。

### 3. 调整 .protyle-action 高度

```css
.protyle-wysiwyg .bq[custom-callout] div[data-type="NodeListItem"] > .protyle-action {
    height: calc(1.625em + 4px) !important;
    line-height: calc(1.625em + 4px) !important;
}
```

将 `.protyle-action`（显示项目符号/序号的容器）高度从 `8px` 改为 `4px`，与列表项的紧凑间距保持一致。

### 4. 添加交互增强

```css
/* 悬停时高亮竖线 */
.protyle-wysiwyg .bq[custom-callout] div[data-type="NodeListItem"]:hover::before {
    border-left-color: var(--b3-scroll-color) !important;
}

/* 折叠状态下隐藏竖线 */
.protyle-wysiwyg .bq[custom-callout] div[data-type="NodeListItem"][fold="1"]::before {
    content: none !important;
}
```

保持与原生思源笔记一致的交互体验。

## 技术细节

### 竖线计算公式解析

原生公式（假设列表项总高度为 `H`）：
```
竖线顶部 = 1.625em（第一行文本高度）+ 12px（间距）
竖线高度 = H - 1.625em - 12px
```

这意味着竖线从第一行文本底部开始，延伸到列表项底部减去间距。

紧凑模式公式（Callout 中）：
```
竖线顶部 = 1.625em + 4px
竖线高度 = H - 1.625em - 4px
```

间距从 `12px` 减少到 `4px`，使竖线适应更紧凑的布局。

### 为什么 left 保持 17px

`left: 17px` 是相对于列表项本身的位置，不是相对于父容器的。即使列表项有 `margin-left: var(--callout-list-indent)`，竖线的 `left` 位置仍然是相对于列表项边缘计算的。

`17px` 大约是 `.protyle-action` 宽度（`34px`）的一半，这样竖线就会出现在项目符号的中心位置，视觉效果更好。

## 测试验证

### 测试场景

1. **基本无序列表**
   ```markdown
   > [!note] 测试列表
   > - 项目 1
   > - 项目 2
   >   - 嵌套项目 2.1
   >   - 嵌套项目 2.2
   > - 项目 3
   ```

2. **有序列表**
   ```markdown
   > [!tip] 有序列表
   > 1. 第一项
   > 2. 第二项
   >    1. 嵌套 2.1
   >    2. 嵌套 2.2
   > 3. 第三项
   ```

3. **混合列表**
   ```markdown
   > [!warning] 混合列表
   > 1. 有序项
   >    - 无序子项
   >      - 深层嵌套
   > 2. 第二项
   ```

### 验证要点

- ✅ 小圆点位置正确
- ✅ 竖线从第一行文本底部开始
- ✅ 竖线延伸到合适的位置
- ✅ 嵌套列表的竖线对齐正确
- ✅ 悬停时竖线高亮
- ✅ 折叠状态下竖线隐藏

## 影响范围

### 修改文件
- `src/callout/styles.ts`

### 影响的样式规则
1. `div[data-type="NodeListItem"]` - 列表项基础样式
2. `div[data-type="NodeListItem"]::before` - 竖线样式
3. `div[data-type="NodeListItem"] > .protyle-action` - 项目符号容器
4. `div[data-type="NodeListItem"][fold="1"]::before` - 折叠状态

### 兼容性
- ✅ 不影响普通文档中的列表显示
- ✅ 只作用于 `custom-callout` 块内的列表
- ✅ 保持与思源笔记原生交互一致
- ✅ 支持所有主题样式

## 相关资料

### 思源笔记列表结构
```
div[data-type="NodeList"]            ← 列表容器
  └── div[data-type="NodeListItem"]  ← 列表项
      ├── .protyle-action            ← 项目符号/序号显示区
      ├── div[data-type="NodeParagraph"]  ← 列表项内容
      └── div[data-type="NodeListItem"]   ← 嵌套列表项（可选）
          └── ...
```

### CSS 变量
- `--callout-list-indent`: 列表缩进（默认 12px）
- `--b3-theme-background-light`: 竖线颜色
- `--b3-scroll-color`: 竖线悬停颜色

## 总结

这次修复解决了 Callout 块中列表竖线错位的问题，核心思路是：

1. **识别根本原因**：思源原生样式使用固定间距值（12px、8px）
2. **适配紧凑布局**：将固定值改为与 Callout 间距匹配的值（4px）
3. **保持一致性**：维持与原生思源笔记相同的交互体验
4. **最小化影响**：只修改必要的样式规则，避免副作用

通过精确调整竖线的 `top`、`height` 和 `.protyle-action` 的高度，使其与紧凑的列表间距完美契合。

---

**修复日期**: 2025-10-09  
**版本**: v1.3.2

